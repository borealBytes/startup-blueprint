name: CI Pipeline

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  # PHASE 1: Quality gates (always runs)
  core-ci:
    name: Core CI
    uses: ./.github/workflows/core-ci.yml
    secrets: inherit

  # PHASE 2: Test & Build (conditional on core-ci completion)
  test-build:
    name: Test & Build
    needs: [core-ci]
    if: always() && (needs.core-ci.result == 'success' || needs.core-ci.result == 'failure')
    uses: ./.github/workflows/test-build.yml
    with:
      changed_workspaces: ${{ needs.core-ci.outputs.changed_workspaces }}
      commit_sha: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
    secrets: inherit

  # PHASE 3: Deploy (only on success, environment-aware)
  deploy:
    name: Deploy
    needs: [core-ci, test-build]
    if: |
      needs.test-build.result == 'success' &&
      (github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'deploy:preview'))
    uses: ./.github/workflows/deploy.yml
    with:
      environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }}
      changed_workspaces: ${{ needs.core-ci.outputs.changed_workspaces }}
    secrets: inherit

  # PHASE 4: AI Agents (analysis, runs after test-build)
  agents:
    name: AI Agents
    needs: [core-ci, test-build]
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft &&
      github.actor != 'dependabot[bot]' &&
      github.actor != 'renovate[bot]'
    uses: ./.github/workflows/agents.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      commit_sha: ${{ github.event.pull_request.head.sha }}
      core_ci_result: ${{ needs.core-ci.result }}
    secrets: inherit
