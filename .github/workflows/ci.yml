name: CI

on:
  pull_request:

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  # Step 1: Run core CI (format, lint, link check)
  core-ci:
    name: Core CI
    uses: ./.github/workflows/core-ci-reusable.yml
    secrets: inherit

  # Step 2: Run CrewAI review ONLY if core CI completes (success or failure)
  crewai-review:
    name: CrewAI Code Review
    needs: [core-ci]
    # Run if:
    # - Core CI completed (success OR failure - we want to analyze failures too!)
    # - Not a bot PR
    # - Not a draft PR
    if: |
      always() &&
      (needs.core-ci.result == 'success' || needs.core-ci.result == 'failure') &&
      github.actor != 'dependabot[bot]' &&
      github.actor != 'renovate[bot]' &&
      !github.event.pull_request.draft
    uses: ./.github/workflows/crewai-review-reusable.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      commit_sha: ${{ github.event.pull_request.head.sha }}
      core_ci_result: ${{ needs.core-ci.result }}  # NEW: Pass CI result
    secrets:
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
