name: CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  # ============================================================================
  # PHASE 1: CORE CI - Quality Gates & Change Detection
  # Runs first - gates all subsequent phases
  # ============================================================================

  01-core-ci-format-lint:
    name: "Phase 1: Core CI » Format & Lint"
    uses: ./.github/workflows/jobs/format-lint.yml
    secrets: inherit

  01-core-ci-detect-changes:
    name: "Phase 1: Core CI » Detect Changes"
    needs: [01-core-ci-format-lint]
    uses: ./.github/workflows/jobs/detect-changes.yml
    secrets: inherit

  # ============================================================================
  # PHASE 2: TEST & BUILD - Per-Workspace Testing & Building
  # Runs after Core CI, conditional on workspace changes
  # ============================================================================

  02-test-docs-links:
    name: "Phase 2: Test » Documentation Links"
    needs: [01-core-ci-format-lint, 01-core-ci-detect-changes]
    if: |
      always() &&
      (needs.01-core-ci-format-lint.result == 'success' || needs.01-core-ci-format-lint.result == 'failure') &&
      contains(needs.01-core-ci-detect-changes.outputs.workspaces, 'docs')
    uses: ./.github/workflows/workspaces/docs-links-test.yml
    with:
      commit_sha: ${{ needs.01-core-ci-format-lint.outputs.final-commit-sha }}
    secrets: inherit

  02-test-crewai:
    name: "Phase 2: Test » CrewAI"
    needs: [01-core-ci-format-lint, 01-core-ci-detect-changes]
    if: |
      always() &&
      (needs.01-core-ci-format-lint.result == 'success' || needs.01-core-ci-format-lint.result == 'failure') &&
      contains(needs.01-core-ci-detect-changes.outputs.workspaces, 'crewai')
    uses: ./.github/workflows/workspaces/crewai-test.yml
    with:
      commit_sha: ${{ needs.01-core-ci-format-lint.outputs.final-commit-sha }}
    secrets: inherit

  # Future workspace: Website Test & Build
  # 02-test-build-website:
  #   name: "Phase 2: Test+Build » Website"
  #   needs: [01-core-ci-format-lint, 01-core-ci-detect-changes]
  #   if: |
  #     always() &&
  #     (needs.01-core-ci-format-lint.result == 'success' || needs.01-core-ci-format-lint.result == 'failure') &&
  #     contains(needs.01-core-ci-detect-changes.outputs.workspaces, 'website')
  #   uses: ./.github/workflows/workspaces/website-test-build.yml
  #   with:
  #     commit_sha: ${{ needs.01-core-ci-format-lint.outputs.final-commit-sha }}
  #   secrets: inherit

  # ============================================================================
  # PHASE 3: DEPLOY - Environment-Aware Deployments
  # Runs after tests succeed, deploys to preview or production
  # ============================================================================

  # Future: Website Preview Deploy (on PR with label or push to staging)
  # 03-deploy-website-preview:
  #   name: "Phase 3: Deploy » Website (Preview)"
  #   needs: [01-core-ci-detect-changes, 02-test-build-website]
  #   if: |
  #     needs.02-test-build-website.result == 'success' &&
  #     contains(needs.01-core-ci-detect-changes.outputs.workspaces, 'website') &&
  #     (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'deploy:preview'))
  #   uses: ./.github/workflows/environments/preview-deploy.yml
  #   with:
  #     workspace: website
  #     build_artifact: website-build
  #   secrets: inherit
  #   environment:
  #     name: preview
  #     url: https://preview.credibilitymarkets.com

  # Future: Website Production Deploy (on push to main)
  # 03-deploy-website-production:
  #   name: "Phase 3: Deploy » Website (Production)"
  #   needs: [01-core-ci-detect-changes, 02-test-build-website]
  #   if: |
  #     needs.02-test-build-website.result == 'success' &&
  #     contains(needs.01-core-ci-detect-changes.outputs.workspaces, 'website') &&
  #     github.ref == 'refs/heads/main' &&
  #     github.event_name == 'push'
  #   uses: ./.github/workflows/environments/production-deploy.yml
  #   with:
  #     workspace: website
  #     build_artifact: website-build
  #   secrets: inherit
  #   environment:
  #     name: production
  #     url: https://credibilitymarkets.com

  # ============================================================================
  # PHASE 4: AGENTS - AI-Powered Analysis & Review
  # Runs after tests complete, analyzes code and posts review
  # ============================================================================

  04-agent-crewai-review:
    name: "Phase 4: Agent » CrewAI Review"
    needs: [
      01-core-ci-format-lint,
      01-core-ci-detect-changes,
      02-test-docs-links,
      02-test-crewai
    ]
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft &&
      github.actor != 'dependabot[bot]' &&
      github.actor != 'renovate[bot]' &&
      (needs.01-core-ci-format-lint.result == 'success' || needs.01-core-ci-format-lint.result == 'failure') &&
      (needs.02-test-docs-links.result == 'success' || needs.02-test-docs-links.result == 'failure' || needs.02-test-docs-links.result == 'skipped') &&
      (needs.02-test-crewai.result == 'success' || needs.02-test-crewai.result == 'failure' || needs.02-test-crewai.result == 'skipped')
    uses: ./.github/workflows/agents/crewai-review.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      commit_sha: ${{ github.event.pull_request.head.sha }}
      core_ci_result: ${{ needs.01-core-ci-format-lint.result }}
    secrets:
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
