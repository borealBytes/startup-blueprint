name: CI

"on":
  pull_request:

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  format-and-lint:
    name: Format and Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Check if lock file exists
        id: check_lockfile
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… pnpm-lock.yaml found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ pnpm-lock.yaml not found - will generate it"
          fi

      - name: Setup Node.js (with cache)
        if: steps.check_lockfile.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup Node.js (without cache)
        if: steps.check_lockfile.outputs.exists != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python (for potential Python projects)
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Setup Go (for future Golang projects)
        uses: actions/setup-go@v5
        with:
          go-version: 1.21
          cache: false

      - name: Install Node dependencies
        run: pnpm install

      - name: Install Python tools (if Python files exist)
        id: check_python
        run: |
          if find . -type f -name "*.py" \
             -not -path "./node_modules/*" \
             -not -path "./.git/*" \
             -not -path "./.venv/*" \
             -not -path "./venv/*" | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ Installing Python linting tools..."
            pip install --quiet black isort flake8
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No Python files found, skipping Python tool installation"
          fi

      - name: Commit lock file if newly generated
        if: steps.check_lockfile.outputs.exists == 'false'
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            echo "ðŸ“ Lock file was generated, committing it..."

            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git add pnpm-lock.yaml
            git commit -m "chore: add pnpm-lock.yaml" -m "Auto-generated by CI workflow on first run." -m "This enables dependency caching for faster subsequent runs."

            git push

            echo "âœ… Lock file committed successfully"
          else
            echo "âš ï¸ Lock file was not generated (unexpected)"
          fi

      - name: Install Go tools (for future)
        run: |
          if [ -d "apps/credibility-markets" ]; then
            go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          else
            echo "â­ï¸ Skipping Go tools (no Go projects yet)"
          fi

      - name: Run Prettier (format all files)
        id: prettier
        continue-on-error: true
        run: |
          npx prettier --write \
            "**/*.{js,ts,jsx,tsx,json,md,yml,yaml,css,scss,html}" \
            --ignore-path .gitignore \
            --log-level warn

          if [ $? -eq 0 ]; then
            echo "status=âœ… Passed" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ Failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run Black (format Python files)
        id: black
        continue-on-error: true
        run: |
          if [ "${{ steps.check_python.outputs.exists }}" == "true" ]; then
            echo "ðŸ Running Black formatter..."

            # Find all .py files excluding common directories
            find . -type f -name "*.py" \
              -not -path "./node_modules/*" \
              -not -path "./.git/*" \
              -not -path "./.venv/*" \
              -not -path "./venv/*" \
              -not -path "./build/*" \
              -not -path "./dist/*" \
              | xargs black --quiet

            if [ $? -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped (no Python files)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No Python files found, skipping Black"
          fi

      - name: Run isort (sort Python imports)
        id: isort
        continue-on-error: true
        run: |
          if [ "${{ steps.check_python.outputs.exists }}" == "true" ]; then
            echo "ðŸ Running isort..."

            # Find all .py files excluding common directories
            find . -type f -name "*.py" \
              -not -path "./node_modules/*" \
              -not -path "./.git/*" \
              -not -path "./.venv/*" \
              -not -path "./venv/*" \
              -not -path "./build/*" \
              -not -path "./dist/*" \
              | xargs isort --quiet

            if [ $? -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped (no Python files)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No Python files found, skipping isort"
          fi

      - name: Run ESLint (auto-fix JS/TS)
        id: eslint
        continue-on-error: true
        run: |
          # Check if any JS/TS files exist (excluding node_modules and .git)
          if find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" \) \
             -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then

            echo "ðŸ” Found JS/TS files, running ESLint..."

            # Run ESLint with --quiet to suppress warnings about all files ignored
            # This happens when only config files exist (*.config.js)
            pnpm exec eslint \
              "**/*.{js,ts,jsx,tsx}" \
              --fix \
              --ignore-path .gitignore \
              --max-warnings 0 \
              2>&1 | tee /tmp/eslint.log

            EXIT_CODE=${PIPESTATUS[0]}

            # Check if error is "all files ignored" (exit code 2)
            if [ $EXIT_CODE -eq 2 ] && grep -q "all of the files matching the glob pattern" /tmp/eslint.log; then
              echo "ðŸ“ All JS/TS files are config files (intentionally ignored)"
              echo "status=â­ï¸ Skipped (only config files)" >> $GITHUB_OUTPUT
            elif [ $EXIT_CODE -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            # No JS/TS files found - skip gracefully
            echo "status=â­ï¸ Skipped (no JS/TS files)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No JavaScript/TypeScript files found, skipping ESLint"
          fi

      - name: Run stylelint (auto-fix CSS/SCSS)
        id: stylelint
        continue-on-error: true
        run: |
          if [ -f ".stylelintrc.json" ]; then
            pnpm exec stylelint \
              "**/*.{css,scss}" \
              --fix \
              --allow-empty-input

            if [ $? -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped" >> $GITHUB_OUTPUT
          fi

      - name: Run markdownlint (auto-fix Markdown)
        id: markdownlint
        continue-on-error: true
        run: |
          pnpm exec markdownlint-cli2 \
            "**/*.md" \
            "#node_modules" \
            "#.github" \
            --fix \
            --config .markdownlint.json

          if [ $? -eq 0 ]; then
            echo "status=âœ… Passed" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ Failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run yamllint (check YAML, no auto-fix)
        id: yamllint
        continue-on-error: true
        run: |
          if command -v yamllint &> /dev/null; then
            yamllint .
            if [ $? -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped" >> $GITHUB_OUTPUT
          fi

      - name: Run shellcheck (check bash scripts)
        id: shellcheck
        continue-on-error: true
        run: |
          if command -v shellcheck &> /dev/null; then
            find . -type f -name "*.sh" -not -path "./node_modules/*" -exec shellcheck {} +
            if [ $? -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped" >> $GITHUB_OUTPUT
          fi

      - name: Run flake8 (lint Python files)
        id: flake8
        continue-on-error: true
        run: |
          if [ "${{ steps.check_python.outputs.exists }}" == "true" ]; then
            echo "ðŸ Running flake8 linter..."

            # Find all .py files excluding common directories
            find . -type f -name "*.py" \
              -not -path "./node_modules/*" \
              -not -path "./.git/*" \
              -not -path "./.venv/*" \
              -not -path "./venv/*" \
              -not -path "./build/*" \
              -not -path "./dist/*" \
              | xargs flake8 --max-line-length=88 --extend-ignore=E203,W503

            if [ $? -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped (no Python files)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No Python files found, skipping flake8"
          fi

      - name: Run gofmt (format Go files)
        id: gofmt
        continue-on-error: true
        run: |
          if [ -d "apps/credibility-markets" ]; then
            gofmt -w apps/credibility-markets/
            echo "status=âœ… Passed" >> $GITHUB_OUTPUT
          else
            echo "status=â­ï¸ Skipped" >> $GITHUB_OUTPUT
          fi

      - name: Run golangci-lint (lint Go files)
        id: golangci
        continue-on-error: true
        run: |
          if [ -d "apps/credibility-markets" ] && command -v golangci-lint &> /dev/null; then
            cd apps/credibility-markets
            golangci-lint run --fix
            if [ $? -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped" >> $GITHUB_OUTPUT
          fi

      - name: Lint commit messages
        id: commitlint
        continue-on-error: true
        run: |
          cat > commitlint.config.js << 'EOF'
          module.exports = {
            extends: ['@commitlint/config-conventional'],
            rules: {
              'type-enum': [
                2,
                'always',
                [
                  'feat',
                  'fix',
                  'docs',
                  'style',
                  'refactor',
                  'perf',
                  'test',
                  'chore',
                  'ci',
                  'build',
                  'revert',
                ],
              ],
              'scope-case': [2, 'always', 'kebab-case'],
              'subject-case': [0],
              'subject-empty': [2, 'never'],
              'subject-full-stop': [2, 'never', '.'],
              'header-max-length': [2, 'always', 100],
              'body-leading-blank': [2, 'always'],
              'body-max-line-length': [0],
              'footer-leading-blank': [2, 'always'],
            },
          };
          EOF

          BASE_REF="${{ github.base_ref || 'main' }}"
          echo "ðŸ” Fetching base branch: origin/$BASE_REF"
          git fetch origin "$BASE_REF" || echo "âš ï¸ Could not fetch $BASE_REF, using HEAD~1"

          if git rev-parse "origin/$BASE_REF" >/dev/null 2>&1; then
            BASE_SHA=$(git merge-base "origin/$BASE_REF" HEAD)
            echo "ðŸ” Linting commits from $BASE_SHA (origin/$BASE_REF) to HEAD"
            pnpm exec commitlint --from "$BASE_SHA" --to HEAD --verbose
          else
            echo "ðŸ” Linting last commit only (no base branch found)"
            pnpm exec commitlint --from HEAD~1 --to HEAD --verbose
          fi

          if [ $? -eq 0 ]; then
            echo "status=âœ… Passed" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ Failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check TypeScript types
        id: typescript
        continue-on-error: true
        run: |
          if [ -f "tsconfig.json" ] || [ -f "apps/*/tsconfig.json" ]; then
            echo "ðŸ” Checking TypeScript types..."

            HAS_ERRORS=0

            if [ -f "tsconfig.json" ]; then
              pnpm exec tsc --noEmit --skipLibCheck
              if [ $? -ne 0 ]; then
                HAS_ERRORS=1
              fi
            fi

            for tsconfig in apps/*/tsconfig.json; do
              if [ -f "$tsconfig" ]; then
                echo "Checking $tsconfig"
                cd $(dirname $tsconfig)
                pnpm exec tsc --noEmit --skipLibCheck
                if [ $? -ne 0 ]; then
                  HAS_ERRORS=1
                fi
                cd - > /dev/null
              fi
            done

            if [ $HAS_ERRORS -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped" >> $GITHUB_OUTPUT
            echo "â­ï¸ No TypeScript projects found"
          fi

      - name: Unstage workflow files (security safeguard)
        if: always()
        run: |
          if [ -d ".github/workflows" ]; then
            echo "ðŸ”’ Ensuring workflow files are not staged..."
            git reset HEAD .github/workflows/ 2>/dev/null || true
            git checkout -- .github/workflows/ 2>/dev/null || true
            echo "âœ… Workflow files excluded from commit"
          fi

      - name: Check for changes
        id: check_changes
        if: always()
        run: |
          git add -A

          if git diff --cached --name-only | grep -q "^\.github/workflows/"; then
            echo "::error::Workflow files are staged despite safeguards!"
            echo "::error::This should never happen. Aborting."
            git diff --cached --name-only | grep "^\.github/workflows/"
            exit 1
          fi

          if git diff --cached --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "file_count=0" >> $GITHUB_OUTPUT
            echo "âœ… No formatting/linting changes needed"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            FILE_COUNT=$(git diff --cached --name-only | wc -l)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected in $FILE_COUNT file(s)"

            git diff --cached --name-only > /tmp/changed_files.txt
          fi

      - name: Generate summary report
        if: always()
        run: |
          FAILED=false
          if [[ "${{ steps.prettier.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.black.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.isort.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.eslint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.stylelint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.markdownlint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.yamllint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.shellcheck.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.flake8.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.gofmt.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.golangci.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.commitlint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.typescript.conclusion }}" == "failure" ]]; then
            FAILED=true
          fi

          if [ "$FAILED" == "true" ]; then
            echo "## âŒ Format & Lint Summary: Failures Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **One or more checks failed. See details below and check " \
              "the [full log](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) " \
              "for errors.**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "## ðŸ“ Format & Lint Summary: Changes Applied" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Format & Lint Summary: All Clean!" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§° Tools Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Prettier** | ${{ steps.prettier.outputs.status || 'âŒ Failed' }} | Format JS/TS/JSON/MD/YAML/CSS |" >> $GITHUB_STEP_SUMMARY
          echo "| **Black** | ${{ steps.black.outputs.status || 'âŒ Failed' }} | Format Python code |" >> $GITHUB_STEP_SUMMARY
          echo "| **isort** | ${{ steps.isort.outputs.status || 'âŒ Failed' }} | Sort Python imports |" >> $GITHUB_STEP_SUMMARY
          echo "| **ESLint** | ${{ steps.eslint.outputs.status || 'âŒ Failed' }} | Lint & auto-fix JS/TS |" >> $GITHUB_STEP_SUMMARY
          echo "| **stylelint** | ${{ steps.stylelint.outputs.status || 'âŒ Failed' }} | Lint & auto-fix CSS/SCSS |" >> $GITHUB_STEP_SUMMARY
          echo "| **markdownlint** | ${{ steps.markdownlint.outputs.status || 'âŒ Failed' }} | Lint & auto-fix Markdown |" >> $GITHUB_STEP_SUMMARY
          echo "| **yamllint** | ${{ steps.yamllint.outputs.status || 'âŒ Failed' }} | Check YAML syntax |" >> $GITHUB_STEP_SUMMARY
          echo "| **shellcheck** | ${{ steps.shellcheck.outputs.status || 'âŒ Failed' }} | Lint Bash scripts |" >> $GITHUB_STEP_SUMMARY
          echo "| **flake8** | ${{ steps.flake8.outputs.status || 'âŒ Failed' }} | Lint Python code |" >> $GITHUB_STEP_SUMMARY
          echo "| **gofmt** | ${{ steps.gofmt.outputs.status || 'âŒ Failed' }} | Format Go code |" >> $GITHUB_STEP_SUMMARY
          echo "| **golangci-lint** | ${{ steps.golangci.outputs.status || 'âŒ Failed' }} | Lint Go code |" >> $GITHUB_STEP_SUMMARY
          echo "| **commitlint** | ${{ steps.commitlint.outputs.status || 'âŒ Failed' }} | Validate commit messages |" >> $GITHUB_STEP_SUMMARY
          echo "| **TypeScript** | ${{ steps.typescript.outputs.status || 'âŒ Failed' }} | Check type errors |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$FAILED" == "true" ]; then
            echo "### ðŸ› ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed checks above and fix the issues:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Check the [full action log](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error messages" >> $GITHUB_STEP_SUMMARY
            echo "2. Fix the issues locally" >> $GITHUB_STEP_SUMMARY
            echo "3. Push your changes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "### ðŸ“ Changed Files (${{ steps.check_changes.outputs.file_count }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/changed_files.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Auto-commit will be created below**" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸŽ‰ No Changes Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All code is properly formatted and linted!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail job if any check failed
        if: always()
        run: |
          if [[ "${{ steps.prettier.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.black.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.isort.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.eslint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.stylelint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.markdownlint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.yamllint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.shellcheck.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.flake8.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.gofmt.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.golangci.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.commitlint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.typescript.conclusion }}" == "failure" ]]; then
            echo "âŒ One or more format/lint checks failed"
            exit 1
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git commit -m "chore: auto-format and lint fixes" -m "Applied automatic formatting and linting fixes."

          COMMIT_SHA=$(git rev-parse HEAD)
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

          git push

          echo "âœ… Committed and pushed formatting fixes"
          echo "ðŸ“ Commit SHA: $COMMIT_SHA"

      - name: Update summary with commit info
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Auto-Commit Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** \`${{ steps.commit.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âž¡ï¸ Documentation link check will run next..." >> $GITHUB_STEP_SUMMARY

      - name: Final summary
        if: steps.check_changes.outputs.changes == 'false' && success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âž¡ï¸ Documentation link check will run next..." >> $GITHUB_STEP_SUMMARY

  link-check:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    needs: [format-and-lint]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Restore lychee cache
        uses: actions/cache@v4
        with:
          path: .lycheecache
          key: cache-lychee-${{ github.sha }}
          restore-keys: cache-lychee-

      - name: Check Markdown links
        uses: lycheeverse/lychee-action@v2.1.0
        with:
          args: >-
            --verbose
            --no-progress
            --cache
            --max-cache-age 1d
            --accept 200,204,429
            --timeout 10
            --max-redirects 5
            --exclude-mail
            '**/*.md'
          output: lychee/out.md
          jobSummary: false
          fail: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display link check results
        if: always()
        run: |
          if [ -f "lychee/out.md" ]; then
            echo "## ðŸ”— Link Check Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat lychee/out.md >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… All Links Valid" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No broken links found in documentation." >> $GITHUB_STEP_SUMMARY
          fi
