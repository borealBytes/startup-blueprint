name: Format & Lint

on:
  workflow_call:
    outputs:
      commit_sha:
        description: 'Final commit SHA after formatting'
        value: ${{ jobs.run.outputs.commit_sha }}

jobs:
  run:
    name: Format & Lint
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      commit_sha: ${{ steps.get-sha.outputs.sha }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install formatting tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort

      - name: Run Black
        run: |
          black --check . || {
            echo "âš ï¸ Code needs formatting. Running black..."
            black .
          }

      - name: Run isort
        run: |
          isort --check . || {
            echo "âš ï¸ Imports need sorting. Running isort..."
            isort .
          }

      - name: Commit formatting changes
        if: github.event_name == 'pull_request'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if ! git diff --quiet; then
            git add .
            git commit -m "style: Auto-format code with black and isort"
            git push
            echo "âœ… Committed formatting changes"
          else
            echo "âœ… No formatting changes needed"
          fi

      - name: Get final commit SHA
        id: get-sha
        run: |
          SHA=$(git rev-parse HEAD)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "ğŸ“ Final commit SHA: $SHA"
