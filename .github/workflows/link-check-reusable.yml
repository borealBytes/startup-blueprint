name: Check Documentation Links (Reusable)

on:
  workflow_call:
    inputs:
      commit_sha:
        description: 'Commit SHA to check'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  link-check:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout specific commit
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Verify checkout
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          EXPECTED_SHA="${{ inputs.commit_sha }}"

          echo "ðŸ” Expected commit: $EXPECTED_SHA"
          echo "ðŸ“ Current commit:  $CURRENT_SHA"

          if [ "$CURRENT_SHA" == "$EXPECTED_SHA" ]; then
            echo "âœ… Checked out correct commit"
          else
            echo "âŒ Commit mismatch!"
            exit 1
          fi

      - name: Restore lychee cache
        uses: actions/cache@v4
        with:
          path: .lycheecache
          key: cache-lychee-${{ github.sha }}
          restore-keys: cache-lychee-

      - name: Check Markdown links
        uses: lycheeverse/lychee-action@v2.1.0
        with:
          args: >-
            --verbose
            --no-progress
            --cache
            --max-cache-age 1d
            --accept 200,204,429
            --timeout 10
            --max-redirects 5
            --exclude-mail
            --exclude 'dos\.ny\.gov/business-services'
            --exclude 'accounts\.google\.com/signup'
            --exclude 'onecorp\.lara\.state\.mi\.us'
            --exclude 'cofs\.lara\.state\.mi\.us'
            --exclude 'bpd\.sos\.ca\.gov'
            --exclude 'bizfileonline\.sos\.ca\.gov'
            --exclude 'apps\.dos\.ny\.gov/publicInquiry'
            --exclude 'nerdwallet\.com/article/small-business/start-an-llc'
            --exclude 'sba\.gov/business-guide/launch/choose-business-structure'
            '**/*.md'
          output: lychee/out.md
          jobSummary: false
          fail: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display link check results
        if: always()
        run: |
          echo "## ðŸ”— Link Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Checked commit:** \`${{ inputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "lychee/out.md" ]; then
            cat lychee/out.md >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All Links Valid" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No broken links found in documentation." >> $GITHUB_STEP_SUMMARY
          fi
