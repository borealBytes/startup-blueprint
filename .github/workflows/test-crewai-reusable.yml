name: Test CrewAI (Reusable)

on:
  workflow_call:
    inputs:
      commit_sha:
        description: 'Commit SHA to test'
        required: true
        type: string

permissions:
  contents: read
  checks: write

jobs:
  test-crewai:
    name: Test CrewAI
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_sha }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        working-directory: .crewai
        run: |
          echo "üì¶ Installing CrewAI dependencies..."
          uv sync

      - name: Run unit tests
        id: unit_tests
        working-directory: .crewai
        continue-on-error: true
        run: |
          if [ -d "tests" ] && [ -f "tests/__init__.py" ]; then
            echo "üß™ Running unit tests..."
            uv run python -m pytest tests/ -v --tb=short
            
            if [ $? -eq 0 ]; then
              echo "status=‚úÖ Passed" >> $GITHUB_OUTPUT
            else
              echo "status=‚ùå Failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=‚è≠Ô∏è Skipped (no tests/ directory)" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No tests directory found, skipping unit tests"
          fi

      - name: Run integration tests
        id: integration_tests
        working-directory: .crewai
        continue-on-error: true
        run: |
          if [ -d "tests/integration" ]; then
            echo "üß™ Running integration tests..."
            uv run python -m pytest tests/integration/ -v --tb=short
            
            if [ $? -eq 0 ]; then
              echo "status=‚úÖ Passed" >> $GITHUB_OUTPUT
            else
              echo "status=‚ùå Failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=‚è≠Ô∏è Skipped (no tests/integration directory)" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No integration tests found, skipping"
          fi

      - name: Check code imports
        id: import_check
        working-directory: .crewai
        continue-on-error: true
        run: |
          echo "üîç Checking if Python modules can be imported..."
          
          uv run python -c "import crew; print('‚úÖ crew module imports successfully')" 2>&1 | tee /tmp/import_check.log
          
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "status=‚úÖ Passed" >> $GITHUB_OUTPUT
          else
            echo "status=‚ùå Failed" >> $GITHUB_OUTPUT
            cat /tmp/import_check.log
            exit 1
          fi

      - name: Generate test summary
        if: always()
        run: |
          echo "## üß™ CrewAI Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tested commit:** \`${{ inputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Unit Tests** | ${{ steps.unit_tests.outputs.status || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Integration Tests** | ${{ steps.integration_tests.outputs.status || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Import Check** | ${{ steps.import_check.outputs.status || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any tests failed
          FAILED=false
          if [[ "${{ steps.unit_tests.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.integration_tests.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.import_check.conclusion }}" == "failure" ]]; then
            FAILED=true
          fi

          if [ "$FAILED" == "true" ]; then
            echo "### ‚ùå Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the test failures above and fix the issues." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ All Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All CrewAI tests completed successfully!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail job if tests failed
        if: always()
        run: |
          if [[ "${{ steps.unit_tests.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.integration_tests.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.import_check.conclusion }}" == "failure" ]]; then
            echo "‚ùå One or more tests failed"
            exit 1
          fi
