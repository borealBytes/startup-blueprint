name: Deploy to Preview

on:
  workflow_call:
    inputs:
      workspace:
        description: 'Workspace to deploy (e.g., website)'
        required: true
        type: string
      build_artifact:
        description: 'Name of the build artifact to deploy'
        required: true
        type: string
      pr_number:
        description: 'Pull request number'
        required: true
        type: number
      head_ref:
        description: 'PR branch name for preview links'
        required: false
        type: string
    outputs:
      deployment_url:
        description: 'URL of the preview deployment'
        value: ${{ jobs.deploy.outputs.url }}
      custom_domain_url:
        description: 'Custom domain URL for the preview'
        value: ${{ jobs.deploy.outputs.custom_url }}

permissions:
  contents: read
  deployments: write
  pull-requests: write

jobs:
  deploy:
    name: Deploy Preview
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      url: ${{ steps.extract_url.outputs.url }}
      custom_url: ${{ steps.extract_url.outputs.custom_url }}

    environment:
      name: preview-pr-${{ inputs.pr_number }}
      url: ${{ steps.extract_url.outputs.custom_url }}

    defaults:
      run:
        working-directory: apps/startup-blueprint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize job capture
        uses: ./.github/actions/capture-job-output
        with:
          job-name: 'deploy-preview'
          mode: 'start'

      - name: Log deployment start
        working-directory: .
        run: |
          mkdir -p "$GITHUB_WORKSPACE/.crewai-job-output"
          echo "ðŸš€ Starting preview deployment" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          echo "Workspace: ${{ inputs.workspace }}" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          echo "PR: #${{ inputs.pr_number }}" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies (including wrangler)
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          pnpm install --frozen-lockfile

      - name: Install jq for JSON processing
        working-directory: .
        run: |
          echo "ðŸ“¦ Installing jq for custom domain management..."
          sudo apt-get update -qq
          sudo apt-get install -y jq
          jq --version

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.build_artifact }}
          path: apps/startup-blueprint/dist

      - name: Update GitHub links for preview branch
        if: ${{ inputs.head_ref != '' }}
        env:
          HEAD_REF: ${{ inputs.head_ref }}
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          head_ref = os.environ.get("HEAD_REF", "").strip()
          if not head_ref:
              raise SystemExit(0)

          path = Path("dist/index.html")
          if not path.exists():
              raise SystemExit("Missing dist/index.html")

          base = "https://github.com/borealBytes/startup-blueprint"
          branch_url = f"{base}/tree/{head_ref}"

          text = path.read_text()
          text = text.replace(base, branch_url)
          path.write_text(text)
          PY

      - name: Create Cloudflare Pages project if needed
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ” Checking if Pages project exists..."
          if pnpm exec wrangler pages project list | grep -q "${{ inputs.workspace }}"; then
            echo "âœ… Project '${{ inputs.workspace }}' already exists"
          else
            echo "ðŸ—ï¸ Creating Pages project '${{ inputs.workspace }}'..."
            pnpm exec wrangler pages project create ${{ inputs.workspace }} --production-branch=main || true
            echo "âœ… Project created"
          fi

      - name: Deploy to Cloudflare Pages
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          mkdir -p "$GITHUB_WORKSPACE/.crewai-job-output"
          echo "ðŸš€ Deploying to Cloudflare Pages..." | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"

          pnpm exec wrangler pages deploy ./dist \
            --project-name=${{ inputs.workspace }} \
            --branch=preview-pr-${{ inputs.pr_number }} | tee deploy_output.txt

          # Extract the deployment URL from wrangler output
          DEPLOY_URL=$(grep -oP 'https://[^\s]+' deploy_output.txt | head -1 || echo "")
          if [ -n "$DEPLOY_URL" ]; then
            echo "deployment_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          fi

      - name: Append deploy output to captured log
        if: always()
        working-directory: apps/startup-blueprint
        run: |
          if [ -f deploy_output.txt ]; then
            echo "" >> "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
            echo "=== wrangler deploy output ===" >> "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
            cat deploy_output.txt >> "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          fi

      - name: Extract deployment URL
        id: extract_url
        working-directory: .
        run: |
          # Try to use the actual deployment URL from wrangler, or fall back to pattern
          if [ -n "${{ steps.deploy.outputs.deployment_url }}" ]; then
            PREVIEW_URL="${{ steps.deploy.outputs.deployment_url }}"
          else
            # Cloudflare Pages preview URL pattern
            PREVIEW_URL="https://preview-pr-${{ inputs.pr_number }}.${{ inputs.workspace }}.pages.dev"
          fi
          echo "url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "âœ… Preview deployed to: $PREVIEW_URL"
          
          # Set custom domain URL (will be configured in next step)
          CUSTOM_DOMAIN_URL="https://preview-startup-blueprint.SuperiorByteWorks.com"
          echo "custom_url=$CUSTOM_DOMAIN_URL" >> $GITHUB_OUTPUT
          echo "ðŸŒ Custom domain will be: $CUSTOM_DOMAIN_URL"

      - name: Configure custom preview domain
        working-directory: .
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸŒ Configuring custom preview domain..."
          
          # Make script executable
          chmod +x scripts/cloudflare/manage-preview-domain.sh
          
          # Run domain management script
          bash scripts/cloudflare/manage-preview-domain.sh \
            "${{ inputs.workspace }}" \
            "${{ steps.extract_url.outputs.url }}"
          
          echo "âœ… Custom domain configured!"

      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'preview-pr-${{ inputs.pr_number }}',
              auto_merge: false,
              required_contexts: [],
              description: 'Preview deployment for PR #${{ inputs.pr_number }}'
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: '${{ steps.extract_url.outputs.custom_url }}',
              description: 'Preview deployment successful'
            });

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.extract_url.outputs.url }}';
            const customUrl = '${{ steps.extract_url.outputs.custom_url }}';
            const workspace = '${{ inputs.workspace }}';

            const comment = `## ðŸš€ Preview Deployment

            Your preview deployment is ready!

            | Item | Value |
            |------|-------|
            | **Workspace** | \`${workspace}\` |
            | **Environment** | Preview |
            | **Custom Domain** | ${customUrl} |
            | **Direct URL** | ${url} |
            | **Commit** | ${context.sha.substring(0, 7)} |

            ### Actions
            - [View Preview (Custom Domain)](${customUrl})
            - [View Preview (Direct)](${url})
            - [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})

            ---

            *This preview will be updated with each new commit while the \`Deploy: Website Preview\` label is active.*
            
            **âš ï¸ Note:** Only one PR should have the \`Deploy: Website Preview\` label at a time, as the custom domain can only point to one deployment.`;

            // Find existing preview comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }}
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Preview Deployment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.pr_number }},
                body: comment
              });
            }

      - name: Verify preview deployment
        working-directory: .
        run: |
          PREVIEW_URL="${{ steps.extract_url.outputs.url }}"
          CUSTOM_URL="${{ steps.extract_url.outputs.custom_url }}"

          echo "ðŸ” Verifying preview deployment..." | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          echo "" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"

          # Wait a moment for deployment to propagate
          sleep 5

          # Check direct URL
          echo "Testing direct URL: $PREVIEW_URL" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL" || echo "000")

          if [ "$HTTP_CODE" == "200" ]; then
            echo "âœ… Direct URL is accessible (HTTP $HTTP_CODE)" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          else
            echo "âš ï¸ Direct URL returned HTTP $HTTP_CODE" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          fi
          
          echo "" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          echo "Testing custom domain: $CUSTOM_URL" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          echo "âš ï¸ Custom domain may take 1-2 minutes to propagate DNS changes" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          
          # Try custom domain (may fail initially due to DNS propagation)
          CUSTOM_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$CUSTOM_URL" || echo "000")
          
          if [ "$CUSTOM_CODE" == "200" ]; then
            echo "âœ… Custom domain is accessible (HTTP $CUSTOM_CODE)" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          else
            echo "âš ï¸ Custom domain returned HTTP $CUSTOM_CODE (may need DNS propagation time)" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          fi
          
          echo "" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"
          echo "âœ… Deployment verification complete" | tee -a "$GITHUB_WORKSPACE/.crewai-job-output/current-job.log"

      - name: Generate deployment summary
        working-directory: .
        run: |
          echo "## ðŸš€ Preview Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment successful and verified!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Access Your Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Custom Domain:** [${{ steps.extract_url.outputs.custom_url }}](${{ steps.extract_url.outputs.custom_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Direct URL:** [${{ steps.extract_url.outputs.url }}](${{ steps.extract_url.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Deployment Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace:** ${{ inputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** preview-pr-${{ inputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Custom Domain:** Configured âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** DNS propagation for the custom domain may take 1-2 minutes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Ready for production deployment on merge to main**" >> $GITHUB_STEP_SUMMARY

      - name: Save summary for capture
        if: always()
        working-directory: .
        run: |
          mkdir -p "$GITHUB_WORKSPACE/.crewai-job-output"
          if [ -n "$GITHUB_STEP_SUMMARY" ] && [ -f "$GITHUB_STEP_SUMMARY" ]; then
            cp "$GITHUB_STEP_SUMMARY" "$GITHUB_WORKSPACE/.crewai-job-output/current-job-summary.md"
          fi

      - name: Finalize job capture
        if: always()
        uses: ./.github/actions/capture-job-output
        with:
          job-name: 'deploy-preview'
          job-conclusion: ${{ job.status }}
          mode: 'finish'
          summary-file: ${{ github.workspace }}/.crewai-job-output/current-job-summary.md

      - name: Upload job output artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-job-output-deploy-preview
          path: ${{ github.workspace }}/.crewai-job-output/
          retention-days: 7
          if-no-files-found: warn
          include-hidden-files: true
