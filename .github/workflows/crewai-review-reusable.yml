name: CrewAI Code Review (Reusable)

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
        description: "Pull request number"
      commit_sha:
        required: true
        type: string
        description: "Commit SHA to review"
      core_ci_result:
        required: false
        type: string
        default: "success"
        description: "Result from core-ci job (success/failure)"
    secrets:
      OPENROUTER_API_KEY:
        required: true
        description: "OpenRouter API key for AI models"

jobs:
  crewai-review:
    name: AI Review
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_sha }}
          fetch-depth: 0  # Full history for commit analysis

      - name: Prepare PR data using local git (no GitHub API)
        id: prepare-data
        run: |
          set -e
          
          echo "ðŸ“¦ Preparing PR data using LOCAL GIT ONLY (no GitHub API for diff)"
          
          # Create workspace directory
          mkdir -p .crewai/workspace
          
          # Get base and head refs from github.event context (no API call needed)
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          
          # Fallback to main if somehow empty
          if [ -z "$BASE_REF" ]; then
            BASE_REF="main"
            echo "âš ï¸ BASE_REF empty, defaulting to main"
          fi
          
          echo "ðŸ“ Base: $BASE_REF, Head: $HEAD_REF"
          echo "ðŸ“ Commit SHA: ${{ inputs.commit_sha }}"
          
          # Fetch the base branch if not present (only git operation needed)
          echo "ðŸ”„ Fetching base branch: $BASE_REF"
          git fetch origin "$BASE_REF:$BASE_REF" 2>/dev/null || \
            git fetch origin "$BASE_REF" 2>/dev/null || \
            echo "âš ï¸ Could not fetch $BASE_REF, using existing ref"
          
          # Generate FULL PR diff using git (base..head) - NO API CALL
          echo "ðŸ“ Generating full PR diff using: origin/$BASE_REF...${{ inputs.commit_sha }}"
          git diff "origin/$BASE_REF...${{ inputs.commit_sha }}" > .crewai/workspace/diff.txt 2>/dev/null || \
            git diff "$BASE_REF...${{ inputs.commit_sha }}" > .crewai/workspace/diff.txt
          
          DIFF_SIZE=$(wc -c < .crewai/workspace/diff.txt)
          echo "âœ… Full PR diff saved: $DIFF_SIZE bytes"
          
          # Fallback if diff is too small (might indicate ref issue)
          if [ "$DIFF_SIZE" -lt 100 ]; then
            echo "âš ï¸ Warning: Diff is suspiciously small ($DIFF_SIZE bytes)"
            echo "ðŸ”„ Trying alternative method with merge-base..."
            
            # Find merge base and diff from there
            MERGE_BASE=$(git merge-base "origin/$BASE_REF" "${{ inputs.commit_sha }}" 2>/dev/null || \
                        git merge-base "$BASE_REF" "${{ inputs.commit_sha }}")
            
            if [ -n "$MERGE_BASE" ]; then
              echo "ðŸ“ Merge base: ${MERGE_BASE:0:8}"
              git diff "$MERGE_BASE...${{ inputs.commit_sha }}" > .crewai/workspace/diff.txt
              DIFF_SIZE=$(wc -c < .crewai/workspace/diff.txt)
              echo "âœ… Fallback diff saved: $DIFF_SIZE bytes"
            else
              echo "âŒ Could not determine merge base"
            fi
          fi
          
          # Count files changed and lines using git diff stats (no API needed)
          echo "ðŸ“Š Calculating diff statistics..."
          DIFF_STATS=$(git diff --stat "origin/$BASE_REF...${{ inputs.commit_sha }}" 2>/dev/null || \
                      git diff --stat "$BASE_REF...${{ inputs.commit_sha }}")
          
          # Extract stats from git diff output
          # Example: "5 files changed, 123 insertions(+), 45 deletions(-)"
          FILES_CHANGED=$(echo "$DIFF_STATS" | tail -n 1 | grep -oE '^[[:space:]]*[0-9]+' | tr -d ' ' || echo "0")
          ADDITIONS=$(echo "$DIFF_STATS" | tail -n 1 | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
          DELETIONS=$(echo "$DIFF_STATS" | tail -n 1 | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")
          
          # Default to 0 if extraction failed
          FILES_CHANGED=${FILES_CHANGED:-0}
          ADDITIONS=${ADDITIONS:-0}
          DELETIONS=${DELETIONS:-0}
          
          echo "ðŸ“Š Stats: $FILES_CHANGED files, +$ADDITIONS/-$DELETIONS lines"
          
          # Get all commits in this PR using local git (no API)
          echo "ðŸ“š Getting PR commits from local git..."
          git log --format='%H|%s|%an|%ae|%aI' --no-merges "origin/$BASE_REF..${{ inputs.commit_sha }}" > /tmp/commits.txt 2>/dev/null || \
            git log --format='%H|%s|%an|%ae|%aI' --no-merges "$BASE_REF..${{ inputs.commit_sha }}" > /tmp/commits.txt 2>/dev/null || \
            echo "" > /tmp/commits.txt
          
          # Build commits JSON array
          echo '[]' > .crewai/workspace/commits.json
          
          if [ -s /tmp/commits.txt ]; then
            while IFS='|' read -r sha message author_name author_email author_date; do
              # Get commit stats from git
              STATS=$(git show --stat --format='' "$sha" 2>/dev/null | tail -n 1 || echo "")
              COMMIT_ADDITIONS=0
              COMMIT_DELETIONS=0
              COMMIT_FILES=0
              
              if echo "$STATS" | grep -q "insertion"; then
                COMMIT_ADDITIONS=$(echo "$STATS" | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo 0)
              fi
              if echo "$STATS" | grep -q "deletion"; then
                COMMIT_DELETIONS=$(echo "$STATS" | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo 0)
              fi
              if echo "$STATS" | grep -q "file"; then
                COMMIT_FILES=$(echo "$STATS" | grep -oE '^[[:space:]]*[0-9]+' | tr -d ' ' || echo 0)
              fi
              
              # Build commit object and append to array
              jq -n \
                --arg sha "${sha:0:8}" \
                --arg message "$message" \
                --arg author_name "$author_name" \
                --arg author_email "$author_email" \
                --arg author_date "$author_date" \
                --argjson additions "${COMMIT_ADDITIONS:-0}" \
                --argjson deletions "${COMMIT_DELETIONS:-0}" \
                --argjson files "${COMMIT_FILES:-0}" \
                '{
                  "sha": $sha,
                  "message": $message,
                  "author": {
                    "name": $author_name,
                    "email": $author_email,
                    "date": $author_date
                  },
                  "stats": {
                    "additions": $additions,
                    "deletions": $deletions,
                    "files_changed": $files
                  }
                }' > /tmp/commit.json
              
              # Append to array
              jq '. += [input]' .crewai/workspace/commits.json /tmp/commit.json > /tmp/commits_new.json
              mv /tmp/commits_new.json .crewai/workspace/commits.json
            done < /tmp/commits.txt
          fi
          
          COMMIT_COUNT=$(jq '. | length' .crewai/workspace/commits.json)
          echo "âœ… Saved $COMMIT_COUNT commits to commits.json"
          
          # Get PR labels from github.event context (no API call)
          PR_LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          
          echo "ðŸ·ï¸ PR Labels: $PR_LABELS"
          
          # Create diff metadata JSON (for router)
          jq -n \
            --argjson pr_number "${{ inputs.pr_number }}" \
            --arg commit_sha "${{ inputs.commit_sha }}" \
            --arg base_ref "$BASE_REF" \
            --arg head_ref "$HEAD_REF" \
            --arg labels "$PR_LABELS" \
            --argjson files_changed "$FILES_CHANGED" \
            --argjson additions "$ADDITIONS" \
            --argjson deletions "$DELETIONS" \
            '{
              "pr_number": $pr_number,
              "commit_sha": $commit_sha,
              "base_ref": $base_ref,
              "head_ref": $head_ref,
              "labels": ($labels | split(",") | map(select(length > 0))),
              "files_changed": $files_changed,
              "additions": $additions,
              "deletions": $deletions,
              "total_changes": ($additions + $deletions)
            }' > .crewai/workspace/diff.json
          
          echo "âœ… Saved PR metadata to diff.json"
          
          # Summary
          echo ""
          echo "ðŸ“‹ Data prepared for CrewAI (LOCAL GIT - NO API CALLS FOR DIFF):"
          echo "  - diff.txt: $DIFF_SIZE bytes (full PR diff)"
          echo "  - commits.json: $COMMIT_COUNT commits"
          echo "  - diff.json: PR metadata"
          echo "  - Files changed: $FILES_CHANGED"
          echo "  - Lines: +$ADDITIONS/-$DELETIONS"
          echo "  - Labels: $PR_LABELS"
          echo ""
          echo "âœ… All data extracted from local git - no GitHub API calls for diff!"

      - name: Setup UV (Python Package Manager)
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: ".crewai/pyproject.toml"

      - name: Install CrewAI dependencies
        working-directory: .crewai
        run: |
          uv sync

      - name: Run CrewAI Router-Based Review
        working-directory: .crewai
        env:
          # API Keys
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # GitHub Context
          PR_NUMBER: ${{ inputs.pr_number }}
          COMMIT_SHA: ${{ inputs.commit_sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          
          # CI Context (from core-ci job)
          CORE_CI_RESULT: ${{ inputs.core_ci_result }}
          
          # GitHub Actions Context
          GITHUB_STEP_SUMMARY: ${{ github.step_summary }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          echo "ðŸš€ Starting CrewAI Router-Based Review System"
          echo "ðŸ“¦ Repository: $GITHUB_REPOSITORY"
          echo "ðŸ”— PR: #$PR_NUMBER"
          echo "ðŸ“ Commit: ${COMMIT_SHA:0:8}"
          echo "âœ… Core CI: $CORE_CI_RESULT"
          echo ""
          echo "ðŸ“‚ Workspace data available:"
          ls -lh workspace/*.{txt,json} 2>/dev/null || echo "  (checking...)"
          echo ""
          
          uv run main.py

      - name: Upload Review Trace
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crewai-review-trace-pr-${{ inputs.pr_number }}
          path: .crewai/workspace/trace/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Complete Workspace
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crewai-workspace-pr-${{ inputs.pr_number }}
          path: .crewai/workspace/
          retention-days: 7
          if-no-files-found: warn
