name: CrewAI Code Review (Reusable)

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
        description: "Pull request number"
      commit_sha:
        required: true
        type: string
        description: "Commit SHA to review"
      core_ci_result:
        required: false
        type: string
        default: "success"
        description: "Result from core-ci job (success/failure)"
    secrets:
      OPENROUTER_API_KEY:
        required: true
        description: "OpenRouter API key for AI models"

jobs:
  crewai-review:
    name: AI Review
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_sha }}
          fetch-depth: 0  # Full history for commit analysis

      - name: Setup UV (Python Package Manager)
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: ".crewai/pyproject.toml"

      - name: Install CrewAI dependencies
        working-directory: .crewai
        run: |
          uv sync --frozen

      - name: Run CrewAI Router-Based Review
        working-directory: .crewai
        env:
          # API Keys
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # GitHub Context
          PR_NUMBER: ${{ inputs.pr_number }}
          COMMIT_SHA: ${{ inputs.commit_sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          
          # CI Context (NEW: from core-ci job)
          CORE_CI_RESULT: ${{ inputs.core_ci_result }}
          
          # GitHub Actions Context
          GITHUB_STEP_SUMMARY: ${{ github.step_summary }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          echo "üöÄ Starting CrewAI Router-Based Review System"
          echo "üì¶ Repository: $GITHUB_REPOSITORY"
          echo "üîó PR: #$PR_NUMBER"
          echo "üìù Commit: ${COMMIT_SHA:0:8}"
          echo "‚úÖ Core CI: $CORE_CI_RESULT"
          echo ""
          
          uv run main.py

      - name: Upload Review Trace
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crewai-review-trace-pr-${{ inputs.pr_number }}
          path: .crewai/workspace/trace/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Workspace (Debug)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: crewai-workspace-debug-pr-${{ inputs.pr_number }}
          path: .crewai/workspace/
          retention-days: 7
          if-no-files-found: warn
