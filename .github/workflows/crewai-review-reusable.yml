name: CrewAI Code Review (Reusable)

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: number
      commit_sha:
        description: 'Commit SHA to review'
        required: true
        type: string
      core_ci_result:
        description: 'Result of Core CI job (success/failure)'
        required: true
        type: string
    secrets:
      OPENROUTER_API_KEY:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    defaults:
      run:
        working-directory: .crewai

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_sha }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: '.crewai/pyproject.toml'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Configure environment
        run: |
          echo "PR_NUMBER=${{ inputs.pr_number }}" >> $GITHUB_ENV
          echo "COMMIT_SHA=${{ inputs.commit_sha }}" >> $GITHUB_ENV
          echo "CORE_CI_RESULT=${{ inputs.core_ci_result }}" >> $GITHUB_ENV
          echo "OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" >> $GITHUB_ENV

      - name: Run CrewAI code review
        run: |
          python main.py

      - name: Read review summary
        id: review
        run: |
          if [ -f "workspace/final_summary.md" ]; then
            SUMMARY=$(cat workspace/final_summary.md)
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "summary=⚠️ Review generation failed. Check workflow logs." >> $GITHUB_OUTPUT
          fi

      - name: Post review as PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const summary = `${{ steps.review.outputs.summary }}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
              body: summary
            });
