name: CrewAI Code Review (Reusable)

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
        description: "Pull request number"
      commit_sha:
        required: true
        type: string
        description: "Commit SHA to review"
      core_ci_result:
        required: false
        type: string
        default: "success"
        description: "Result from core-ci job (success/failure)"
    secrets:
      OPENROUTER_API_KEY:
        required: true
        description: "OpenRouter API key for AI models"

jobs:
  crewai-review:
    name: AI Review
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_sha }}
          fetch-depth: 0  # Full history for commit analysis

      - name: Prepare PR data for CrewAI agents
        id: prepare-data
        run: |
          set -e
          
          echo "ðŸ“¦ Preparing PR data for AI agents"
          
          # Create workspace directory
          mkdir -p .crewai/workspace
          
          # Get PR information using GitHub API
          PR_DATA=$(gh pr view ${{ inputs.pr_number }} --json number,title,body,labels,files,additions,deletions,changedFiles,baseRefName,headRefName)
          
          echo "ðŸ“Š PR Metadata:"
          echo "$PR_DATA" | jq -r '.number, .title, .changedFiles'
          
          # Extract base and head refs
          BASE_REF=$(echo "$PR_DATA" | jq -r '.baseRefName')
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.headRefName')
          
          echo "ðŸ“ Base: $BASE_REF, Head: $HEAD_REF"
          
          # Fetch the base branch
          git fetch origin "$BASE_REF:$BASE_REF" || true
          
          # Generate FULL PR diff (base..head) - this is what agents need!
          echo "ðŸ“ Generating full PR diff (base..head)..."
          git diff "origin/$BASE_REF...${{ inputs.commit_sha }}" > .crewai/workspace/diff.txt
          
          DIFF_SIZE=$(wc -c < .crewai/workspace/diff.txt)
          echo "âœ… Full PR diff saved: $DIFF_SIZE bytes"
          
          if [ "$DIFF_SIZE" -lt 100 ]; then
            echo "âš ï¸ Warning: Diff is suspiciously small. Trying alternative method..."
            # Fallback: use merge-base
            MERGE_BASE=$(git merge-base "origin/$BASE_REF" "${{ inputs.commit_sha }}")
            git diff "$MERGE_BASE...${{ inputs.commit_sha }}" > .crewai/workspace/diff.txt
            DIFF_SIZE=$(wc -c < .crewai/workspace/diff.txt)
            echo "âœ… Fallback diff saved: $DIFF_SIZE bytes"
          fi
          
          # Get all commits in this PR
          echo "ðŸ“š Getting PR commits..."
          git log --format='%H|%s|%an|%ae|%aI' "origin/$BASE_REF..${{ inputs.commit_sha }}" > /tmp/commits.txt
          
          # Convert to JSON array
          echo '[' > .crewai/workspace/commits.json
          FIRST=true
          while IFS='|' read -r sha message author_name author_email author_date; do
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              echo ',' >> .crewai/workspace/commits.json
            fi
            
            # Get stats for this commit
            STATS=$(git show --stat --format='' "$sha" | tail -n 1)
            ADDITIONS=0
            DELETIONS=0
            FILES=0
            
            if echo "$STATS" | grep -q "insertion"; then
              ADDITIONS=$(echo "$STATS" | sed -n 's/.* \([0-9]\+\) insertion.*/\1/p')
            fi
            if echo "$STATS" | grep -q "deletion"; then
              DELETIONS=$(echo "$STATS" | sed -n 's/.* \([0-9]\+\) deletion.*/\1/p')
            fi
            if echo "$STATS" | grep -q "file"; then
              FILES=$(echo "$STATS" | sed -n 's/^ *\([0-9]\+\) file.*/\1/p')
            fi
            
            cat >> .crewai/workspace/commits.json <<EOF
            {
              "sha": "${sha:0:8}",
              "message": $(echo "$message" | jq -R .),
              "author": {
                "name": $(echo "$author_name" | jq -R .),
                "email": $(echo "$author_email" | jq -R .),
                "date": $(echo "$author_date" | jq -R .)
              },
              "stats": {
                "additions": ${ADDITIONS:-0},
                "deletions": ${DELETIONS:-0},
                "files_changed": ${FILES:-0}
              }
            }
EOF
          done < /tmp/commits.txt
          echo ']' >> .crewai/workspace/commits.json
          
          COMMIT_COUNT=$(jq '. | length' .crewai/workspace/commits.json)
          echo "âœ… Saved $COMMIT_COUNT commits to commits.json"
          
          # Create diff metadata JSON (for router)
          PR_LABELS=$(echo "$PR_DATA" | jq -r '.labels | map(.name) | join(",")')
          CHANGED_FILES=$(echo "$PR_DATA" | jq -r '.changedFiles')
          ADDITIONS=$(echo "$PR_DATA" | jq -r '.additions')
          DELETIONS=$(echo "$PR_DATA" | jq -r '.deletions')
          
          cat > .crewai/workspace/diff.json <<EOF
          {
            "pr_number": ${{ inputs.pr_number }},
            "commit_sha": "${{ inputs.commit_sha }}",
            "base_ref": "$BASE_REF",
            "head_ref": "$HEAD_REF",
            "labels": $(echo "$PR_LABELS" | jq -R 'split(",")'),
            "files_changed": $CHANGED_FILES,
            "additions": $ADDITIONS,
            "deletions": $DELETIONS,
            "total_changes": $((ADDITIONS + DELETIONS))
          }
EOF
          
          echo "âœ… Saved PR metadata to diff.json"
          
          # Summary
          echo ""
          echo "ðŸ“‹ Data prepared for CrewAI:"
          echo "  - diff.txt: $DIFF_SIZE bytes (full PR diff)"
          echo "  - commits.json: $COMMIT_COUNT commits"
          echo "  - diff.json: PR metadata"
          echo "  - Files changed: $CHANGED_FILES"
          echo "  - Lines: +$ADDITIONS/-$DELETIONS"
          
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup UV (Python Package Manager)
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: ".crewai/pyproject.toml"

      - name: Install CrewAI dependencies
        working-directory: .crewai
        run: |
          uv sync

      - name: Run CrewAI Router-Based Review
        working-directory: .crewai
        env:
          # API Keys
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # GitHub Context
          PR_NUMBER: ${{ inputs.pr_number }}
          COMMIT_SHA: ${{ inputs.commit_sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          
          # CI Context (NEW: from core-ci job)
          CORE_CI_RESULT: ${{ inputs.core_ci_result }}
          
          # GitHub Actions Context
          GITHUB_STEP_SUMMARY: ${{ github.step_summary }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          echo "ðŸš€ Starting CrewAI Router-Based Review System"
          echo "ðŸ“¦ Repository: $GITHUB_REPOSITORY"
          echo "ðŸ”— PR: #$PR_NUMBER"
          echo "ðŸ“ Commit: ${COMMIT_SHA:0:8}"
          echo "âœ… Core CI: $CORE_CI_RESULT"
          echo ""
          echo "ðŸ“‚ Workspace data available:"
          ls -lh workspace/*.{txt,json} 2>/dev/null || echo "  (checking...)"
          echo ""
          
          uv run main.py

      - name: Upload Review Trace
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crewai-review-trace-pr-${{ inputs.pr_number }}
          path: .crewai/workspace/trace/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Complete Workspace
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crewai-workspace-pr-${{ inputs.pr_number }}
          path: .crewai/workspace/
          retention-days: 7
          if-no-files-found: warn
