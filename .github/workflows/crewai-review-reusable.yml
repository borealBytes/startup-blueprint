name: CrewAI Review

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: number
      commit_sha:
        description: 'Commit SHA to review'
        required: true
        type: string
      core_ci_result:
        description: 'Result of Core CI job (success/failure)'
        required: true
        type: string
    secrets:
      OPENROUTER_API_KEY:
        required: true

permissions:
  contents: read
  pull-requests: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ========================================
      # STEP 0: Initialize log capture
      # ========================================
      - name: Initialize job capture
        uses: ./.github/actions/capture-job-output
        with:
          job-name: 'crewai-review'
          mode: 'start'
      
      # ========================================
      # STEP 1: Checkout with logging
      # ========================================
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_sha }}
          fetch-depth: 0
      
      - name: Log checkout complete
        run: |
          echo "âœ… Code checked out" | tee -a .crewai-job-output/current-job.log
          echo "  Repository: ${{ github.repository }}" | tee -a .crewai-job-output/current-job.log
          echo "  Commit: ${{ inputs.commit_sha }}" | tee -a .crewai-job-output/current-job.log
          echo "" | tee -a .crewai-job-output/current-job.log

      # ========================================
      # STEP 2: Prepare PR data with logging
      # ========================================
      - name: Prepare PR data using local git
        working-directory: .crewai
        run: |
          set -e
          
          echo "ðŸ“¦ Preparing PR data using LOCAL GIT (no API calls)" | tee -a ../.crewai-job-output/current-job.log
          echo "" | tee -a ../.crewai-job-output/current-job.log
          
          mkdir -p workspace

          # Get base and head refs from github.event context
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"

          # Fallback to main if empty
          if [ -z "$BASE_REF" ]; then
            BASE_REF="main"
            echo "âš ï¸ BASE_REF empty, defaulting to main" | tee -a ../.crewai-job-output/current-job.log
          fi

          echo "ðŸ“ Base: $BASE_REF, Head: $HEAD_REF" | tee -a ../.crewai-job-output/current-job.log
          echo "ðŸ“ Commit SHA: ${{ inputs.commit_sha }}" | tee -a ../.crewai-job-output/current-job.log

          # Fetch base branch
          echo "ðŸ”„ Fetching base branch: $BASE_REF" | tee -a ../.crewai-job-output/current-job.log
          git fetch origin "$BASE_REF:$BASE_REF" 2>&1 | tee -a ../.crewai-job-output/current-job.log || \
            git fetch origin "$BASE_REF" 2>&1 | tee -a ../.crewai-job-output/current-job.log || \
            echo "âš ï¸ Could not fetch $BASE_REF" | tee -a ../.crewai-job-output/current-job.log

          # Generate PR diff using git
          echo "ðŸ“ Generating PR diff: origin/$BASE_REF...${{ inputs.commit_sha }}" | tee -a ../.crewai-job-output/current-job.log
          git diff "origin/$BASE_REF...${{ inputs.commit_sha }}" > workspace/diff.txt 2>/dev/null || \
            git diff "$BASE_REF...${{ inputs.commit_sha }}" > workspace/diff.txt

          DIFF_SIZE=$(wc -c < workspace/diff.txt)
          echo "âœ… PR diff saved: $DIFF_SIZE bytes" | tee -a ../.crewai-job-output/current-job.log

          # Fallback for small diffs
          if [ "$DIFF_SIZE" -lt 100 ]; then
            echo "âš ï¸ Diff suspiciously small, trying merge-base..." | tee -a ../.crewai-job-output/current-job.log
            MERGE_BASE=$(git merge-base "origin/$BASE_REF" "${{ inputs.commit_sha }}" 2>/dev/null || \
                        git merge-base "$BASE_REF" "${{ inputs.commit_sha }}")
            if [ -n "$MERGE_BASE" ]; then
              git diff "$MERGE_BASE...${{ inputs.commit_sha }}" > workspace/diff.txt
              DIFF_SIZE=$(wc -c < workspace/diff.txt)
              echo "âœ… Fallback diff: $DIFF_SIZE bytes" | tee -a ../.crewai-job-output/current-job.log
            fi
          fi

          # Calculate diff stats
          echo "ðŸ“Š Calculating stats..." | tee -a ../.crewai-job-output/current-job.log
          DIFF_STATS=$(git diff --stat "origin/$BASE_REF...${{ inputs.commit_sha }}" 2>/dev/null || \
                      git diff --stat "$BASE_REF...${{ inputs.commit_sha }}")

          FILES_CHANGED=$(echo "$DIFF_STATS" | tail -n 1 | grep -oE '^[[:space:]]*[0-9]+' | tr -d ' ' || echo "0")
          ADDITIONS=$(echo "$DIFF_STATS" | tail -n 1 | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
          DELETIONS=$(echo "$DIFF_STATS" | tail -n 1 | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")

          FILES_CHANGED=${FILES_CHANGED:-0}
          ADDITIONS=${ADDITIONS:-0}
          DELETIONS=${DELETIONS:-0}

          echo "ðŸ“Š Stats: $FILES_CHANGED files, +$ADDITIONS/-$DELETIONS" | tee -a ../.crewai-job-output/current-job.log

          # Extract commits
          echo "ðŸ“š Getting commits..." | tee -a ../.crewai-job-output/current-job.log
          git log --format='%H|%s|%an|%ae|%aI' --no-merges "origin/$BASE_REF..${{ inputs.commit_sha }}" > /tmp/commits.txt 2>/dev/null || \
            git log --format='%H|%s|%an|%ae|%aI' --no-merges "$BASE_REF..${{ inputs.commit_sha }}" > /tmp/commits.txt 2>/dev/null || \
            echo "" > /tmp/commits.txt

          # Build commits JSON
          echo '[]' > workspace/commits.json
          if [ -s /tmp/commits.txt ]; then
            while IFS='|' read -r sha message author_name author_email author_date; do
              STATS=$(git show --stat --format='' "$sha" 2>/dev/null | tail -n 1 || echo "")
              COMMIT_ADDITIONS=$(echo "$STATS" | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo 0)
              COMMIT_DELETIONS=$(echo "$STATS" | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo 0)
              COMMIT_FILES=$(echo "$STATS" | grep -oE '^[[:space:]]*[0-9]+' | tr -d ' ' || echo 0)

              jq -n \
                --arg sha "${sha:0:8}" \
                --arg message "$message" \
                --arg author_name "$author_name" \
                --arg author_email "$author_email" \
                --arg author_date "$author_date" \
                --argjson additions "${COMMIT_ADDITIONS:-0}" \
                --argjson deletions "${COMMIT_DELETIONS:-0}" \
                --argjson files "${COMMIT_FILES:-0}" \
                '{
                  "sha": $sha,
                  "message": $message,
                  "author": {"name": $author_name, "email": $author_email, "date": $author_date},
                  "stats": {"additions": $additions, "deletions": $deletions, "files_changed": $files}
                }' > /tmp/commit.json

              jq '. += [input]' workspace/commits.json /tmp/commit.json > /tmp/commits_new.json
              mv /tmp/commits_new.json workspace/commits.json
            done < /tmp/commits.txt
          fi

          COMMIT_COUNT=$(jq '. | length' workspace/commits.json)
          echo "âœ… Saved $COMMIT_COUNT commits" | tee -a ../.crewai-job-output/current-job.log

          # Get labels from context
          PR_LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          echo "ðŸ·ï¸ Labels: $PR_LABELS" | tee -a ../.crewai-job-output/current-job.log

          # Create metadata JSON
          jq -n \
            --argjson pr_number "${{ inputs.pr_number }}" \
            --arg commit_sha "${{ inputs.commit_sha }}" \
            --arg base_ref "$BASE_REF" \
            --arg head_ref "$HEAD_REF" \
            --arg labels "$PR_LABELS" \
            --argjson files_changed "$FILES_CHANGED" \
            --argjson additions "$ADDITIONS" \
            --argjson deletions "$DELETIONS" \
            '{
              "pr_number": $pr_number,
              "commit_sha": $commit_sha,
              "base_ref": $base_ref,
              "head_ref": $head_ref,
              "labels": ($labels | split(",") | map(select(length > 0))),
              "files_changed": $files_changed,
              "additions": $additions,
              "deletions": $deletions,
              "total_changes": ($additions + $deletions)
            }' > workspace/diff.json

          echo "âœ… Metadata saved" | tee -a ../.crewai-job-output/current-job.log
          echo "" | tee -a ../.crewai-job-output/current-job.log
          echo "ðŸ“‹ Summary (LOCAL GIT - NO API):" | tee -a ../.crewai-job-output/current-job.log
          echo "  - diff.txt: $DIFF_SIZE bytes" | tee -a ../.crewai-job-output/current-job.log
          echo "  - commits.json: $COMMIT_COUNT commits" | tee -a ../.crewai-job-output/current-job.log
          echo "  - diff.json: metadata" | tee -a ../.crewai-job-output/current-job.log
          echo "  - Stats: $FILES_CHANGED files, +$ADDITIONS/-$DELETIONS" | tee -a ../.crewai-job-output/current-job.log
          echo "" | tee -a ../.crewai-job-output/current-job.log

      # ========================================
      # STEP 3: Download CI artifacts
      # ========================================
      - name: Download CI job outputs
        uses: actions/download-artifact@v4
        with:
          pattern: ci-job-output-*
          path: ci-artifacts
          merge-multiple: true
        continue-on-error: true
      
      - name: Log artifact download
        run: |
          echo "ðŸ“¥ Downloaded CI artifacts:" | tee -a .crewai-job-output/current-job.log
          ls -la ci-artifacts 2>&1 | tee -a .crewai-job-output/current-job.log || echo "No artifacts" | tee -a .crewai-job-output/current-job.log
          echo "" | tee -a .crewai-job-output/current-job.log

      # ========================================
      # STEP 4: Organize CI results
      # ========================================
      - name: Organize CI results in workspace
        working-directory: .crewai
        run: |
          set -e

          echo "ðŸ“‚ Organizing CI job data..." | tee -a ../.crewai-job-output/current-job.log
          mkdir -p workspace/ci_results

          # Check if artifacts were downloaded
          if [ ! -d "../ci-artifacts" ]; then
            echo "âš ï¸ No CI artifacts found - jobs may not have uploaded data" | tee -a ../.crewai-job-output/current-job.log
            echo '{"run_id": ${{ github.run_id }}, "run_number": ${{ github.run_number }}, "jobs": []}' > workspace/ci_results/_job_index.json
            echo "" | tee -a ../.crewai-job-output/current-job.log
            exit 0
          fi

          # Move job folders to workspace
          for job_folder in ../ci-artifacts/*/; do
            if [ -d "$job_folder" ]; then
              JOB_NAME=$(basename "$job_folder")
              mv "$job_folder" "workspace/ci_results/$JOB_NAME" 2>/dev/null || true
              echo "  Moved $JOB_NAME" | tee -a ../.crewai-job-output/current-job.log
            fi
          done

          # Build job index from metadata files
          echo '{"run_id": ${{ github.run_id }}, "run_number": ${{ github.run_number }}, "jobs": []}' > workspace/ci_results/_job_index.json

          for metadata in workspace/ci_results/*/metadata.json; do
            if [ -f "$metadata" ]; then
              JOB_DATA=$(cat "$metadata")
              jq --argjson job "$JOB_DATA" '.jobs += [$job]' workspace/ci_results/_job_index.json > /tmp/index_new.json
              mv /tmp/index_new.json workspace/ci_results/_job_index.json
              echo "  Added $(echo "$JOB_DATA" | jq -r '.job_name') to index" | tee -a ../.crewai-job-output/current-job.log
            fi
          done

          JOB_COUNT=$(jq '.jobs | length' workspace/ci_results/_job_index.json)
          echo "âœ… Organized $JOB_COUNT jobs for analysis" | tee -a ../.crewai-job-output/current-job.log
          echo "" | tee -a ../.crewai-job-output/current-job.log

      # ========================================
      # STEP 5: Setup Python with logging
      # ========================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: '.crewai/pyproject.toml'
      
      - name: Log Python setup
        run: |
          echo "âœ… Python setup complete" | tee -a .crewai-job-output/current-job.log
          python --version | tee -a .crewai-job-output/current-job.log
          echo "" | tee -a .crewai-job-output/current-job.log

      # ========================================
      # STEP 6: Install dependencies with logging
      # ========================================
      - name: Install dependencies
        working-directory: .crewai
        run: |
          echo "ðŸ“¦ Installing CrewAI dependencies..." | tee -a ../.crewai-job-output/current-job.log
          python -m pip install --upgrade pip 2>&1 | tee -a ../.crewai-job-output/current-job.log
          pip install -e . 2>&1 | tee -a ../.crewai-job-output/current-job.log
          echo "" | tee -a ../.crewai-job-output/current-job.log

      # ========================================
      # STEP 7: Configure environment
      # ========================================
      - name: Configure environment
        run: |
          echo "ðŸ”§ Configuring environment..." | tee -a .crewai-job-output/current-job.log
          echo "PR_NUMBER=${{ inputs.pr_number }}" >> $GITHUB_ENV
          echo "COMMIT_SHA=${{ inputs.commit_sha }}" >> $GITHUB_ENV
          echo "CORE_CI_RESULT=${{ inputs.core_ci_result }}" >> $GITHUB_ENV
          echo "OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" >> $GITHUB_ENV
          echo "" | tee -a .crewai-job-output/current-job.log

      # ========================================
      # STEP 8: Run CrewAI with full logging
      # ========================================
      - name: Run CrewAI code review
        working-directory: .crewai
        run: |
          echo "ðŸŽ¬ Starting CrewAI orchestration..." | tee -a ../.crewai-job-output/current-job.log
          echo "" | tee -a ../.crewai-job-output/current-job.log
          
          # Run main.py with full output to both stdout and log
          python main.py 2>&1 | tee -a ../.crewai-job-output/current-job.log

      # ========================================
      # STEP 9: Upload workspace artifacts
      # ========================================
      - name: Upload agent workspace artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crewai-agent-workspace-pr${{ inputs.pr_number }}-${{ github.run_id }}
          path: |
            .crewai/workspace/
          retention-days: 7
          if-no-files-found: warn

      # ========================================
      # STEP 10: Finalize log capture
      # ========================================
      - name: Finalize job capture
        if: always()
        uses: ./.github/actions/capture-job-output
        with:
          job-name: 'crewai-review'
          job-conclusion: ${{ job.status }}
          mode: 'finish'
