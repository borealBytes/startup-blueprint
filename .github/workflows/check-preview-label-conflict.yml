name: Check Preview Label Conflicts

on:
  pull_request:
    types: [labeled, unlabeled, opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  check_conflicts:
    name: Check for Label Conflicts
    runs-on: ubuntu-latest
    if: "contains(github.event.pull_request.labels.*.name, 'Deploy: Website Preview')"

    steps:
      - name: Check for multiple PRs with preview label
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const currentPR = context.payload.pull_request.number;
            const targetLabel = 'Deploy: Website Preview';

            console.log(`Checking for conflicts with label: ${targetLabel}`);
            console.log(`Current PR: #${currentPR}`);

            // Find all open PRs with the preview label
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const prsWithLabel = prs.filter(pr =>
              pr.labels.some(label => label.name === targetLabel)
            );

            console.log(`Found ${prsWithLabel.length} PR(s) with the label`);

            if (prsWithLabel.length > 1) {
              const conflictingPRs = prsWithLabel
                .filter(pr => pr.number !== currentPR)
                .map(pr => `#${pr.number}`);

              console.log(`Conflict detected! Other PRs: ${conflictingPRs.join(', ')}`);

              core.setOutput('has_conflict', 'true');
              core.setOutput('conflicting_prs', conflictingPRs.join(', '));
              core.setOutput('total_count', prsWithLabel.length);
            } else {
              console.log('No conflicts detected');
              core.setOutput('has_conflict', 'false');
            }

      - name: Post warning comment on conflicting PRs
        if: steps.check.outputs.has_conflict == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const currentPR = context.payload.pull_request.number;
            const conflictingPRs = '${{ steps.check.outputs.conflicting_prs }}'.split(', ');
            const totalCount = '${{ steps.check.outputs.total_count }}';

            const warningComment = `## âš ï¸ Preview Label Conflict Detected

            **Warning:** Multiple pull requests (${totalCount}) currently have the \`Deploy: Website Preview\` label.

            ### Why This Matters

            The custom preview domain \`preview-startup-blueprint.SuperiorByteWorks.com\` can only point to **one** deployment at a time. When multiple PRs have this label:

            - The custom domain will point to whichever deployment ran **most recently**
            - Other labeled PRs will still have their direct Cloudflare URLs available
            - This may cause confusion about which PR is actually "live" on the custom domain

            ### Conflicting PRs

            ${conflictingPRs.map(pr => `- ${pr}`).join('\n')}

            ### Recommended Action

            **Remove the \`Deploy: Website Preview\` label from all but one PR** to ensure predictable custom domain behavior.

            The PR that keeps the label will have its preview accessible at:
            - ðŸŒ Custom domain: https://preview-startup-blueprint.SuperiorByteWorks.com
            - ðŸ”— Direct URL: (shown in deployment comment)

            Other PRs can still be previewed using their direct Cloudflare Pages URLs.

            ---

            *This is an automated warning. The system will continue to function, but only the most recently deployed PR will be accessible via the custom domain.*`;

            // Post comment on current PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: currentPR
            });

            const existingWarning = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Preview Label Conflict Detected')
            );

            if (existingWarning) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingWarning.id,
                body: warningComment
              });
              console.log(`Updated warning comment on PR #${currentPR}`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: currentPR,
                body: warningComment
              });
              console.log(`Posted warning comment on PR #${currentPR}`);
            }

            // Also post on other conflicting PRs
            for (const prNumber of conflictingPRs.map(pr => parseInt(pr.replace('#', '')))) {
              const { data: prComments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });

              const existingPRWarning = prComments.find(c =>
                c.user.type === 'Bot' &&
                c.body.includes('Preview Label Conflict Detected')
              );

              if (existingPRWarning) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingPRWarning.id,
                  body: warningComment
                });
                console.log(`Updated warning on PR #${prNumber}`);
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: warningComment
                });
                console.log(`Posted warning on PR #${prNumber}`);
              }
            }

      - name: Remove old warning if conflict resolved
        if: steps.check.outputs.has_conflict == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const currentPR = context.payload.pull_request.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: currentPR
            });

            const warningComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Preview Label Conflict Detected')
            );

            if (warningComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: warningComment.id
              });
              console.log(`Removed resolved conflict warning from PR #${currentPR}`);
            } else {
              console.log('No conflict warning to remove');
            }
