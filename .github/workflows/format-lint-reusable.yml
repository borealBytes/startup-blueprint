name: Format & Lint

on:
  workflow_call:
    outputs:
      final-commit-sha:
        description: 'Final commit SHA after formatting/linting'
        value: ${{ jobs.run.outputs.commit-sha }}

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      commit-sha: ${{ steps.output_sha.outputs.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Capture initial commit SHA
        id: initial_sha
        run: |
          INITIAL_SHA=$(git rev-parse HEAD)
          echo "sha=$INITIAL_SHA" >> $GITHUB_OUTPUT
          echo "ðŸ“ Initial commit SHA: $INITIAL_SHA"

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Check if lock file exists
        id: check_lockfile
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… pnpm-lock.yaml found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ pnpm-lock.yaml not found - will generate it"
          fi

      - name: Setup Node.js (with cache)
        if: steps.check_lockfile.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup Node.js (without cache)
        if: steps.check_lockfile.outputs.exists != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python (for potential Python projects)
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Setup Go (for future Golang projects)
        uses: actions/setup-go@v5
        with:
          go-version: 1.21
          cache: false

      - name: Install Node dependencies
        run: pnpm install

      - name: Install Python tools (if Python files exist)
        id: check_python
        run: |
          if find . -type f -name "*.py" \
             -not -path "./node_modules/*" \
             -not -path "./.git/*" \
             -not -path "./.venv/*" \
             -not -path "./venv/*" | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ Installing Python linting tools..."
            pip install --quiet black isort ruff
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No Python files found, skipping Python tool installation"
          fi

      - name: Install SQL tools (if SQL files exist)
        id: check_sql
        run: |
          if find . -type f -name "*.sql" \
             -not -path "./node_modules/*" \
             -not -path "./.git/*" \
             -not -path "./build/*" \
             -not -path "./dist/*" | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ—„ï¸  Installing SQLFluff..."
            pip install --quiet sqlfluff
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No SQL files found, skipping SQL tool installation"
          fi

      - name: Commit lock file if newly generated
        if: steps.check_lockfile.outputs.exists == 'false'
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            echo "ðŸ“ Lock file was generated, committing it..."

            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git add pnpm-lock.yaml
            git commit -m "chore: add pnpm-lock.yaml" \
              -m "Auto-generated by CI workflow on first run." \
              -m "This enables dependency caching for faster subsequent runs."

            git push

            echo "âœ… Lock file committed successfully"
          else
            echo "âš ï¸ Lock file was not generated (unexpected)"
          fi

      - name: Install Go tools (for future)
        run: |
          if [ -d "apps/credibility-markets" ]; then
            go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          else
            echo "â­ï¸ Skipping Go tools (no Go projects yet)"
          fi

      - name: Run Prettier (format all files)
        id: prettier
        continue-on-error: true
        run: |
          npx prettier --write \
            "**/*.{js,ts,jsx,tsx,json,md,yml,yaml,css,scss,html}" \
            --ignore-path .gitignore \
            --log-level warn 2>&1 | tee /tmp/prettier.log

          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            git diff --name-only > /tmp/prettier_changes.txt
          else
            echo "status=âŒ Failed" >> $GITHUB_OUTPUT
            ERRORS=$(grep -c "Error" /tmp/prettier.log 2>/dev/null || echo 0)
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run Black (format Python files)
        id: black
        continue-on-error: true
        run: |
          if [ "${{ steps.check_python.outputs.exists }}" == "true" ]; then
            echo "ðŸ Running Black formatter..."

            find . -type f -name "*.py" \
              -not -path "./node_modules/*" \
              -not -path "./.git/*" \
              -not -path "./.venv/*" \
              -not -path "./venv/*" \
              -not -path "./build/*" \
              -not -path "./dist/*" \
              | xargs black --quiet 2>&1 | tee /tmp/black.log

            EXIT_CODE=${PIPESTATUS[0]}
            if [ $EXIT_CODE -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
              git diff --name-only > /tmp/black_changes.txt
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              ERRORS=$(grep -c "error" /tmp/black.log 2>/dev/null || echo 0)
              echo "errors=$ERRORS" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped (no Python files)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No Python files found, skipping Black"
            touch /tmp/black_changes.txt
          fi

      - name: Run isort (sort Python imports)
        id: isort
        continue-on-error: true
        run: |
          if [ "${{ steps.check_python.outputs.exists }}" == "true" ]; then
            echo "ðŸ Running isort..."

            find . -type f -name "*.py" \
              -not -path "./node_modules/*" \
              -not -path "./.git/*" \
              -not -path "./.venv/*" \
              -not -path "./venv/*" \
              -not -path "./build/*" \
              -not -path "./dist/*" \
              | xargs isort --quiet 2>&1 | tee /tmp/isort.log

            EXIT_CODE=${PIPESTATUS[0]}
            if [ $EXIT_CODE -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
              git diff --name-only > /tmp/isort_changes.txt
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              ERRORS=$(grep -c "ERROR" /tmp/isort.log 2>/dev/null || echo 0)
              echo "errors=$ERRORS" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped (no Python files)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No Python files found, skipping isort"
            touch /tmp/isort_changes.txt
          fi

      - name: Run SQLFluff (format & lint SQL files)
        id: sqlfluff
        continue-on-error: true
        run: |
          if [ "${{ steps.check_sql.outputs.exists }}" == "true" ]; then
            echo "ðŸ—„ï¸  Running SQLFluff formatter and linter..."

            # Use sqlite dialect for D1 databases
            sqlfluff fix --dialect sqlite --force . \
              --exclude-rules ambiguous.column_count 2>&1 | tee /tmp/sqlfluff.log

            if sqlfluff lint --dialect sqlite . \
              --exclude-rules ambiguous.column_count 2>&1 | tee -a /tmp/sqlfluff.log; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
              git diff --name-only > /tmp/sqlfluff_changes.txt
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              # Count actual violations, not just lines
              ERRORS=$(grep -c "^L:" /tmp/sqlfluff.log 2>/dev/null || echo 0)
              WARNINGS=$(grep -c "WARNING" /tmp/sqlfluff.log 2>/dev/null || echo 0)
              echo "errors=$ERRORS" >> $GITHUB_OUTPUT
              echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped (no SQL files)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No SQL files found, skipping SQLFluff"
            touch /tmp/sqlfluff_changes.txt
          fi

      - name: Run ESLint (auto-fix JS/TS)
        id: eslint
        continue-on-error: true
        run: |
          JS_TS_FILES=$(find . -type f \
            \( -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" \) \
            -not -path "./node_modules/*" -not -path "./.git/*")

          if echo "$JS_TS_FILES" | grep -q .; then
            echo "ðŸ” Found JS/TS files, running ESLint..."

            pnpm exec eslint \
              "**/*.{js,ts,jsx,tsx}" \
              --fix \
              --ignore-path .gitignore \
              --max-warnings 0 \
              --format json \
              --output-file /tmp/eslint.json \
              2>&1 | tee /tmp/eslint.log

            EXIT_CODE=${PIPESTATUS[0]}

            if [ $EXIT_CODE -eq 2 ] && \
               grep -q "all of the files matching the glob pattern" /tmp/eslint.log; then
              echo "ðŸ“ All JS/TS files are config files (intentionally ignored)"
              echo "status=â­ï¸ Skipped (only config files)" >> $GITHUB_OUTPUT
              touch /tmp/eslint_changes.txt
            elif [ $EXIT_CODE -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
              git diff --name-only > /tmp/eslint_changes.txt
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              # Parse JSON output for detailed error counts
              if [ -f /tmp/eslint.json ]; then
                ERROR_COUNT=$(jq '[.[].errorCount] | add // 0' \
                  /tmp/eslint.json 2>/dev/null || echo 0)
                WARN_COUNT=$(jq '[.[].warningCount] | add // 0' \
                  /tmp/eslint.json 2>/dev/null || echo 0)
                echo "errors=$ERROR_COUNT" >> $GITHUB_OUTPUT
                echo "warnings=$WARN_COUNT" >> $GITHUB_OUTPUT
              else
                echo "errors=1" >> $GITHUB_OUTPUT
                echo "warnings=0" >> $GITHUB_OUTPUT
              fi
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped (no JS/TS files)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No JavaScript/TypeScript files found, skipping ESLint"
            touch /tmp/eslint_changes.txt
          fi

      - name: Run stylelint (auto-fix CSS/SCSS)
        id: stylelint
        continue-on-error: true
        run: |
          if [ -f ".stylelintrc.json" ]; then
            pnpm exec stylelint \
              "**/*.{css,scss}" \
              --fix \
              --allow-empty-input 2>&1 | tee /tmp/stylelint.log

            EXIT_CODE=${PIPESTATUS[0]}
            if [ $EXIT_CODE -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
              git diff --name-only > /tmp/stylelint_changes.txt
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              ERRORS=$(grep -c "Ã—" /tmp/stylelint.log 2>/dev/null || echo 0)
              echo "errors=$ERRORS" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped (no stylelint config)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No .stylelintrc.json found, skipping stylelint"
            touch /tmp/stylelint_changes.txt
          fi

      - name: Run markdownlint (auto-fix Markdown)
        id: markdownlint
        continue-on-error: true
        run: |
          pnpm exec markdownlint-cli2 \
            "**/*.md" \
            "#node_modules" \
            "#.github" \
            --fix \
            --config .markdownlint.json 2>&1 | tee /tmp/markdownlint.log

          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            git diff --name-only > /tmp/markdownlint_changes.txt
          else
            echo "status=âŒ Failed" >> $GITHUB_OUTPUT
            # Count errors from output
            ERRORS=$(grep -c "MD[0-9]\{3\}" /tmp/markdownlint.log 2>/dev/null || echo 0)
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run yamllint (check YAML, no auto-fix)
        id: yamllint
        continue-on-error: true
        run: |
          if command -v yamllint &> /dev/null; then
            yamllint . 2>&1 | tee /tmp/yamllint.log
            EXIT_CODE=${PIPESTATUS[0]}
            if [ $EXIT_CODE -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              ERRORS=$(grep -c "error" /tmp/yamllint.log 2>/dev/null || echo 0)
              WARNINGS=$(grep -c "warning" /tmp/yamllint.log 2>/dev/null || echo 0)
              echo "errors=$ERRORS" >> $GITHUB_OUTPUT
              echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped (yamllint not installed)" >> $GITHUB_OUTPUT
            echo "â­ï¸ yamllint not found, skipping YAML validation"
          fi

      - name: Run shellcheck (check bash scripts)
        id: shellcheck
        continue-on-error: true
        run: |
          if command -v shellcheck &> /dev/null; then
            if find . -type f -name "*.sh" -not -path "./node_modules/*" | grep -q .; then
              find . -type f -name "*.sh" -not -path "./node_modules/*" \
                -exec shellcheck --format=gcc {} + 2>&1 | tee /tmp/shellcheck.log
              EXIT_CODE=${PIPESTATUS[0]}
              if [ $EXIT_CODE -eq 0 ]; then
                echo "status=âœ… Passed" >> $GITHUB_OUTPUT
              else
                echo "status=âŒ Failed" >> $GITHUB_OUTPUT
                ERRORS=$(grep -c "error:" /tmp/shellcheck.log 2>/dev/null || echo 0)
                WARNINGS=$(grep -c "warning:" /tmp/shellcheck.log 2>/dev/null || echo 0)
                INFO=$(grep -c "note:" /tmp/shellcheck.log 2>/dev/null || echo 0)
                echo "errors=$ERRORS" >> $GITHUB_OUTPUT
                echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
                echo "info=$INFO" >> $GITHUB_OUTPUT
                exit 1
              fi
            else
              echo "status=â­ï¸ Skipped (no shell scripts)" >> $GITHUB_OUTPUT
              echo "â­ï¸ No .sh files found, skipping shellcheck"
            fi
          else
            echo "status=â­ï¸ Skipped (shellcheck not installed)" >> $GITHUB_OUTPUT
            echo "â­ï¸ shellcheck not found, skipping shell script validation"
          fi

      - name: Run ruff (lint & auto-fix Python files)
        id: ruff
        continue-on-error: true
        run: |
          if [ "${{ steps.check_python.outputs.exists }}" == "true" ]; then
            echo "ðŸ Running ruff linter with auto-fix..."

            # Run ruff check with --fix to auto-fix issues
            ruff check . --fix --output-format=json > /tmp/ruff.json 2>&1 || true

            # Also run ruff format to ensure consistent formatting
            ruff format . 2>&1 | tee /tmp/ruff_format.log

            # Check if there are any remaining violations after fixes
            ruff check . --output-format=json > /tmp/ruff_final.json 2>&1
            EXIT_CODE=$?

            if [ $EXIT_CODE -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
              git diff --name-only > /tmp/ruff_changes.txt
              echo "errors=0" >> $GITHUB_OUTPUT
              echo "warnings=0" >> $GITHUB_OUTPUT
            else
              # Count remaining violations
              if [ -f /tmp/ruff_final.json ]; then
                ERROR_COUNT=$(jq 'length' /tmp/ruff_final.json 2>/dev/null || echo 0)
                echo "status=âŒ Failed ($ERROR_COUNT violations)" >> $GITHUB_OUTPUT
                echo "errors=$ERROR_COUNT" >> $GITHUB_OUTPUT
              else
                echo "status=âŒ Failed" >> $GITHUB_OUTPUT
                echo "errors=1" >> $GITHUB_OUTPUT
              fi
              git diff --name-only > /tmp/ruff_changes.txt

              # Show some violations in the output
              echo "::error::Ruff found $ERROR_COUNT violations that couldn't be auto-fixed"
              ruff check . --output-format=concise | head -n 10
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped (no Python files)" >> $GITHUB_OUTPUT
            echo "errors=0" >> $GITHUB_OUTPUT
            echo "â­ï¸ No Python files found, skipping ruff"
            touch /tmp/ruff_changes.txt
          fi

      - name: Run gofmt (format Go files)
        id: gofmt
        continue-on-error: true
        run: |
          if [ -d "apps/credibility-markets" ]; then
            gofmt -w apps/credibility-markets/
            echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            git diff --name-only > /tmp/gofmt_changes.txt
          else
            echo "status=â­ï¸ Skipped (no Go projects)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No Go projects found, skipping gofmt"
            touch /tmp/gofmt_changes.txt
          fi

      - name: Run golangci-lint (lint Go files)
        id: golangci
        continue-on-error: true
        run: |
          if [ -d "apps/credibility-markets" ]; then
            if command -v golangci-lint &> /dev/null; then
              cd apps/credibility-markets
              golangci-lint run --fix 2>&1 | tee /tmp/golangci.log
              EXIT_CODE=${PIPESTATUS[0]}
              if [ $EXIT_CODE -eq 0 ]; then
                echo "status=âœ… Passed" >> $GITHUB_OUTPUT
                git diff --name-only > /tmp/golangci_changes.txt
              else
                echo "status=âŒ Failed" >> $GITHUB_OUTPUT
                ERRORS=$(grep -c "^Error:" /tmp/golangci.log 2>/dev/null || echo 0)
                echo "errors=$ERRORS" >> $GITHUB_OUTPUT
                exit 1
              fi
            else
              echo "status=â­ï¸ Skipped (golangci-lint not installed)" >> $GITHUB_OUTPUT
              echo "â­ï¸ golangci-lint not found, skipping Go linting"
              touch /tmp/golangci_changes.txt
            fi
          else
            echo "status=â­ï¸ Skipped (no Go projects)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No Go projects found, skipping golangci-lint"
            touch /tmp/golangci_changes.txt
          fi

      - name: Lint commit messages
        id: commitlint
        continue-on-error: true
        run: |
          cat > commitlint.config.js << 'EOF'
          module.exports = {
            extends: ['@commitlint/config-conventional'],
            rules: {
              'type-enum': [
                2,
                'always',
                [
                  'feat',
                  'fix',
                  'docs',
                  'style',
                  'refactor',
                  'perf',
                  'test',
                  'chore',
                  'ci',
                  'build',
                  'revert',
                ],
              ],
              'scope-case': [2, 'always', 'kebab-case'],
              'subject-case': [0],
              'subject-empty': [2, 'never'],
              'subject-full-stop': [2, 'never', '.'],
              'header-max-length': [2, 'always', 100],
              'body-leading-blank': [2, 'always'],
              'body-max-line-length': [0],
              'footer-leading-blank': [2, 'always'],
            },
          };
          EOF

          BASE_REF="${{ github.base_ref || 'main' }}"
          echo "ðŸ” Fetching base branch: origin/$BASE_REF"
          git fetch origin "$BASE_REF" || echo "âš ï¸ Could not fetch $BASE_REF, using HEAD~1"

          if git rev-parse "origin/$BASE_REF" >/dev/null 2>&1; then
            BASE_SHA=$(git merge-base "origin/$BASE_REF" HEAD)
            echo "ðŸ” Linting commits from $BASE_SHA (origin/$BASE_REF) to HEAD"
            pnpm exec commitlint --from "$BASE_SHA" --to HEAD --verbose \
              2>&1 | tee /tmp/commitlint.log
          else
            echo "ðŸ” Linting last commit only (no base branch found)"
            pnpm exec commitlint --from HEAD~1 --to HEAD --verbose \
              2>&1 | tee /tmp/commitlint.log
          fi

          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=âœ… Passed" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ Failed" >> $GITHUB_OUTPUT
            ERRORS=$(grep -c "âŒ" /tmp/commitlint.log 2>/dev/null || echo 0)
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check TypeScript types
        id: typescript
        continue-on-error: true
        run: |
          if [ -f "tsconfig.json" ] || [ -f "apps/*/tsconfig.json" ]; then
            echo "ðŸ” Checking TypeScript types..."

            HAS_ERRORS=0

            if [ -f "tsconfig.json" ]; then
              pnpm exec tsc --noEmit --skipLibCheck 2>&1 | tee /tmp/typescript.log
              if [ ${PIPESTATUS[0]} -ne 0 ]; then
                HAS_ERRORS=1
              fi
            fi

            for tsconfig in apps/*/tsconfig.json; do
              if [ -f "$tsconfig" ]; then
                echo "Checking $tsconfig"
                cd $(dirname $tsconfig)
                pnpm exec tsc --noEmit --skipLibCheck 2>&1 | tee -a /tmp/typescript.log
                if [ ${PIPESTATUS[0]} -ne 0 ]; then
                  HAS_ERRORS=1
                fi
                cd - > /dev/null
              fi
            done

            if [ $HAS_ERRORS -eq 0 ]; then
              echo "status=âœ… Passed" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Failed" >> $GITHUB_OUTPUT
              ERRORS=$(grep -c "error TS" /tmp/typescript.log 2>/dev/null || echo 0)
              echo "errors=$ERRORS" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=â­ï¸ Skipped (no TypeScript config)" >> $GITHUB_OUTPUT
            echo "â­ï¸ No tsconfig.json found, skipping TypeScript type checking"
          fi

      - name: Unstage workflow files (security safeguard)
        if: always()
        run: |
          if [ -d ".github/workflows" ]; then
            echo "ðŸ”’ Ensuring workflow files are not staged..."
            git reset HEAD .github/workflows/ 2>/dev/null || true
            git checkout -- .github/workflows/ 2>/dev/null || true
            echo "âœ… Workflow files excluded from commit"
          fi

      - name: Clean tracking files (remove unstaged workflow files)
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning tracking files to match staged files..."

          for tracking_file in /tmp/*_changes.txt; do
            if [ -f "$tracking_file" ]; then
              grep -v "^\.github/workflows/" "$tracking_file" \
                > "${tracking_file}.tmp" 2>/dev/null || touch "${tracking_file}.tmp"
              mv "${tracking_file}.tmp" "$tracking_file"

              REMAINING=$(wc -l < "$tracking_file" 2>/dev/null || echo 0)
              if [ "$REMAINING" -gt 0 ]; then
                echo "âœ… $(basename $tracking_file): $REMAINING file(s) remaining after cleanup"
              fi
            fi
          done

          echo "âœ… Tracking files cleaned - commit message will be accurate"

      - name: Check for changes
        id: check_changes
        if: always()
        run: |
          git add -A

          if git diff --cached --name-only | grep -q "^\.github/workflows/"; then
            echo "::error::Workflow files are staged despite safeguards!"
            echo "::error::This should never happen. Aborting."
            git diff --cached --name-only | grep "^\.github/workflows/"
            exit 1
          fi

          if git diff --cached --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "file_count=0" >> $GITHUB_OUTPUT
            echo "âœ… No formatting/linting changes needed"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            FILE_COUNT=$(git diff --cached --name-only | wc -l)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected in $FILE_COUNT file(s)"

            git diff --cached --name-only > /tmp/changed_files.txt
          fi

      - name: Generate enhanced summary report
        if: always()
        run: |
          FAILED=false

          # Explicitly check each step conclusion
          if [[ "${{ steps.prettier.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.black.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.isort.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.sqlfluff.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.eslint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.stylelint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.markdownlint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.yamllint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.shellcheck.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.ruff.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.gofmt.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.golangci.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.commitlint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.typescript.conclusion }}" == "failure" ]]; then
            FAILED=true
          fi

          if [ "$FAILED" == "true" ]; then
            echo "## âŒ Format & Lint Summary: Failures Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs"
            LOG_URL="${LOG_URL}/${{ github.run_id }}"
            echo "âš ï¸ **One or more checks failed. See details below and check the" \
              "[full log]($LOG_URL) for errors.**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "## ðŸ“ Format & Lint Summary: Changes Applied" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Format & Lint Summary: All Clean!" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸª§ Tools Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Errors | Warnings | Info | Sample Issues |" \
            >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|--------|----------|------|---------------|" \
            >> $GITHUB_STEP_SUMMARY

          # Function to get first N lines from a log file
          get_sample_issues() {
            local log_file="$1"
            local pattern="$2"
            local max_lines="${3:-3}"

            if [ -f "$log_file" ]; then
              grep "$pattern" "$log_file" 2>/dev/null | head -n $max_lines \
                | sed 's/^/`/;s/$/`/' | tr '\n' ' ' | sed 's/ $//' || echo "-"
            else
              echo "-"
            fi
          }

          # Prettier
          PRETTIER_ISSUES=$(get_sample_issues "/tmp/prettier.log" "Error")
          PRETTIER_STATUS="${{ steps.prettier.outputs.status || 'âŒ Failed' }}"
          echo "| **Prettier** | $PRETTIER_STATUS |" \
            "${{ steps.prettier.outputs.errors || '0' }} | - | - | $PRETTIER_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          # Black
          BLACK_ISSUES=$(get_sample_issues "/tmp/black.log" "error")
          echo "| **Black** | ${{ steps.black.outputs.status || 'âŒ Failed' }} |" \
            "${{ steps.black.outputs.errors || '0' }} | - | - | $BLACK_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          # isort
          ISORT_ISSUES=$(get_sample_issues "/tmp/isort.log" "ERROR")
          echo "| **isort** | ${{ steps.isort.outputs.status || 'âŒ Failed' }} |" \
            "${{ steps.isort.outputs.errors || '0' }} | - | - | $ISORT_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          # SQLFluff - Only show issues if it failed
          if [ "${{ steps.sqlfluff.conclusion }}" == "failure" ]; then
            SQLFLUFF_ISSUES=$(get_sample_issues "/tmp/sqlfluff.log" "^L:")
          else
            SQLFLUFF_ISSUES="-"
          fi
          SQLFLUFF_STATUS="${{ steps.sqlfluff.outputs.status || 'âŒ Failed' }}"
          echo "| **SQLFluff** | $SQLFLUFF_STATUS |" \
            "${{ steps.sqlfluff.outputs.errors || '0' }} |" \
            "${{ steps.sqlfluff.outputs.warnings || '0' }} | - | $SQLFLUFF_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          # ESLint - Include both errors and warnings
          if [ -f "/tmp/eslint.json" ]; then
            ESLINT_ISSUES=$(jq -r \
              '[.[].messages[] | select(.severity == 1 or .severity == 2) |
              "\(.ruleId) (\(.line):\(.column))" ] | .[0:3] | join(", ")' \
              /tmp/eslint.json 2>/dev/null || echo "-")
          else
            ESLINT_ISSUES="-"
          fi
          ESLINT_STATUS="${{ steps.eslint.outputs.status || 'âŒ Failed' }}"
          echo "| **ESLint** | $ESLINT_STATUS |" \
            "${{ steps.eslint.outputs.errors || '0' }} |" \
            "${{ steps.eslint.outputs.warnings || '0' }} | - | $ESLINT_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          # stylelint
          STYLELINT_ISSUES=$(get_sample_issues "/tmp/stylelint.log" "Ã—")
          STYLELINT_STATUS="${{ steps.stylelint.outputs.status || 'âŒ Failed' }}"
          echo "| **stylelint** | $STYLELINT_STATUS |" \
            "${{ steps.stylelint.outputs.errors || '0' }} | - | - | $STYLELINT_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          # markdownlint
          MDLINT_ISSUES=$(get_sample_issues "/tmp/markdownlint.log" "MD[0-9]")
          MDLINT_STATUS="${{ steps.markdownlint.outputs.status || 'âŒ Failed' }}"
          echo "| **markdownlint** | $MDLINT_STATUS |" \
            "${{ steps.markdownlint.outputs.errors || '0' }} | - | - | $MDLINT_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          # yamllint
          YAMLLINT_ISSUES=$(get_sample_issues "/tmp/yamllint.log" "error")
          YAMLLINT_STATUS="${{ steps.yamllint.outputs.status || 'âŒ Failed' }}"
          echo "| **yamllint** | $YAMLLINT_STATUS |" \
            "${{ steps.yamllint.outputs.errors || '0' }} |" \
            "${{ steps.yamllint.outputs.warnings || '0' }} | - | $YAMLLINT_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          # shellcheck
          SHELLCHECK_ISSUES=$(get_sample_issues "/tmp/shellcheck.log" "error:")
          SHELLCHECK_STATUS="${{ steps.shellcheck.outputs.status || 'âŒ Failed' }}"
          echo "| **shellcheck** | $SHELLCHECK_STATUS |" \
            "${{ steps.shellcheck.outputs.errors || '0' }} |" \
            "${{ steps.shellcheck.outputs.warnings || '0' }} |" \
            "${{ steps.shellcheck.outputs.info || '0' }} | $SHELLCHECK_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          # ruff (replacing flake8)
          if [ -f "/tmp/ruff_final.json" ] && \
             [ "${{ steps.ruff.outputs.errors }}" != "0" ]; then
            RUFF_ISSUES=$(jq -r '.[0:3] | .[] |
              "\(.code) at \(.filename):\(.location.row)"' \
              /tmp/ruff_final.json 2>/dev/null \
              | sed 's/^/`/;s/$/`/' | tr '\n' ' ' | sed 's/ $//' || echo "-")
          else
            RUFF_ISSUES="-"
          fi
          RUFF_STATUS="${{ steps.ruff.outputs.status || 'âŒ Failed' }}"
          echo "| **ruff** | $RUFF_STATUS | ${{ steps.ruff.outputs.errors || '0' }} |" \
            "- | - | $RUFF_ISSUES |" >> $GITHUB_STEP_SUMMARY

          # gofmt
          GOFMT_STATUS="${{ steps.gofmt.outputs.status || 'âŒ Failed' }}"
          echo "| **gofmt** | $GOFMT_STATUS | 0 | - | - | - |" >> $GITHUB_STEP_SUMMARY

          # golangci-lint
          GOLANGCI_ISSUES=$(get_sample_issues "/tmp/golangci.log" "^Error:")
          GOLANGCI_STATUS="${{ steps.golangci.outputs.status || 'âŒ Failed' }}"
          echo "| **golangci-lint** | $GOLANGCI_STATUS |" \
            "${{ steps.golangci.outputs.errors || '0' }} | - | - | $GOLANGCI_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          # commitlint
          COMMITLINT_ISSUES=$(get_sample_issues "/tmp/commitlint.log" "âŒ")
          COMMITLINT_STATUS="${{ steps.commitlint.outputs.status || 'âŒ Failed' }}"
          echo "| **commitlint** | $COMMITLINT_STATUS |" \
            "${{ steps.commitlint.outputs.errors || '0' }} | - | - | $COMMITLINT_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          # TypeScript
          TYPESCRIPT_ISSUES=$(get_sample_issues "/tmp/typescript.log" "error TS")
          TYPESCRIPT_STATUS="${{ steps.typescript.outputs.status || 'âŒ Failed' }}"
          echo "| **TypeScript** | $TYPESCRIPT_STATUS |" \
            "${{ steps.typescript.outputs.errors || '0' }} | - | - | $TYPESCRIPT_ISSUES |" \
            >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$FAILED" == "true" ]; then
            echo "### ðŸ› ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed checks above and fix the issues:" \
              >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs"
            LOG_URL="${LOG_URL}/${{ github.run_id }}"
            echo "1. Check the [full action log]($LOG_URL)" \
              "for detailed error messages" >> $GITHUB_STEP_SUMMARY
            echo "2. Fix the issues locally" >> $GITHUB_STEP_SUMMARY
            echo "3. Push your changes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "### ðŸ“ Changed Files (${{ steps.check_changes.outputs.file_count }})" \
              >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/changed_files.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Auto-commit will be created below**" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸŽ‰ No Changes Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All code is properly formatted and linted!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail job if any check failed
        if: always()
        run: |
          # Explicitly check each step conclusion
          if [[ "${{ steps.prettier.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.black.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.isort.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.sqlfluff.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.eslint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.stylelint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.markdownlint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.yamllint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.shellcheck.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.ruff.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.gofmt.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.golangci.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.commitlint.conclusion }}" == "failure" ]] || \
             [[ "${{ steps.typescript.conclusion }}" == "failure" ]]; then
            echo "âŒ One or more format/lint checks failed"
            exit 1
          fi

      - name: Build commit message with per-tool breakdown
        if: steps.check_changes.outputs.changes == 'true'
        id: build_message
        run: |
          cat > /tmp/commit_message.txt << 'COMMIT_MSG_EOF'
          chore: auto-format and lint fixes

          Applied automatic formatting and linting fixes.

          ðŸ“ Changed Files (${{ steps.check_changes.outputs.file_count }})
          COMMIT_MSG_EOF

          TOOLS=("Prettier:/tmp/prettier_changes.txt" "Black:/tmp/black_changes.txt" \
                 "isort:/tmp/isort_changes.txt" "SQLFluff:/tmp/sqlfluff_changes.txt" \
                 "ESLint:/tmp/eslint_changes.txt" "stylelint:/tmp/stylelint_changes.txt" \
                 "markdownlint:/tmp/markdownlint_changes.txt" "ruff:/tmp/ruff_changes.txt" \
                 "gofmt:/tmp/gofmt_changes.txt" "golangci-lint:/tmp/golangci_changes.txt")

          for tool_info in "${TOOLS[@]}"; do
            tool_name="${tool_info%%:*}"
            tool_file="${tool_info##*:}"

            if [ -f "$tool_file" ] && [ -s "$tool_file" ]; then
              echo "" >> /tmp/commit_message.txt
              echo "$tool_name:" >> /tmp/commit_message.txt
              while IFS= read -r file; do
                echo "- $file" >> /tmp/commit_message.txt
              done < "$tool_file"
            fi
          done

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git commit -F /tmp/commit_message.txt

          BOT_COMMIT_SHA=$(git rev-parse HEAD)
          echo "sha=$BOT_COMMIT_SHA" >> $GITHUB_OUTPUT

          git push

          echo "âœ… Committed and pushed formatting fixes"
          echo "ðŸ“ Bot commit SHA: $BOT_COMMIT_SHA"

      - name: Output final commit SHA
        id: output_sha
        if: always()
        run: |
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            FINAL_SHA="${{ steps.commit.outputs.sha }}"
            echo "ðŸ¤– Using bot commit SHA: $FINAL_SHA"
          else
            FINAL_SHA="${{ steps.initial_sha.outputs.sha }}"
            echo "ðŸ“ Using original commit SHA: $FINAL_SHA"
          fi

          echo "sha=$FINAL_SHA" >> $GITHUB_OUTPUT

      - name: Update summary with final commit
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "### âœ… Auto-Commit Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Commit SHA:** \`${{ steps.commit.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸŽ‰ No Changes Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            INITIAL_SHA="${{ steps.initial_sha.outputs.sha }}"
            echo "**Original Commit SHA:** \`$INITIAL_SHA\`" >> $GITHUB_STEP_SUMMARY
          fi
