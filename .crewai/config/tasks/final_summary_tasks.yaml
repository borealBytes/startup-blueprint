# IMPORTANT: Task key must match the @task method name in final_summary_crew.py
synthesize_summary:
  description: >
    Read ALL workspace outputs and create final comprehensive markdown report.

    === STEP 1: CHECK WORKSPACE FILES ===

    FIRST, check if critical workspace files exist using WorkspaceTool.exists():
    - workspace/router_decision.json (REQUIRED)
    - workspace/diff.txt (REQUIRED - if missing, indicates router failed)
    - workspace/ci_summary.json (REQUIRED)
    - workspace/quick_review.json (REQUIRED)
    - workspace/full_review.json (optional - only if full-review ran)

    IF ANY REQUIRED FILE IS MISSING:
    Create a CRITICAL ERROR summary explaining which files are missing and
    what likely went wrong. Example:

    ## üö® CrewAI Review FAILED

    **Critical Error**: Review workflow did not complete successfully.

    ### Missing Files:
    - ‚ùå `workspace/diff.txt` - Router failed to fetch commit diff
    - ‚ùå `workspace/quick_review.json` - Quick review did not run

    ### Root Cause:
    The router agent failed to fetch the commit diff, which prevented all
    downstream reviews from running. Check the router crew logs for errors.

    ### Action Required:
    1. Check GitHub Actions logs for the Router step
    2. Verify COMMIT_SHA environment variable is set
    3. Verify GitHub API credentials are valid

    WORKSPACE INPUTS (read all that exist):
    - workspace/router_decision.json: Router suggestions and metadata
    - workspace/diff.txt: Commit diff (if missing = CRITICAL ERROR)
    - workspace/ci_summary.json: CI analysis results
    - workspace/quick_review.json: Quick code review findings
    - workspace/ci_correlation.json: CI issue correlations
    - workspace/full_review.json: Full technical review (if ran)
    - workspace/legal_review.json: Legal review (if ran - future)
    - workspace/commits.json: Commit history context

    YOUR TASK:
    Create ONE cohesive GitHub-flavored markdown report that synthesizes all
    findings into a scannable, actionable summary.

    === GITHUB MARKDOWN FORMATTING RULES ===

    CRITICAL: DO NOT wrap your entire output in a code block (no ```markdown)!
    Your output must be DIRECT markdown that GitHub will render beautifully.

    Use these GitHub-flavored markdown elements:

    1. HEADINGS: Use ## for main sections, ### for subsections
       CORRECT: ## üìä Review Summary
       WRONG: # Review Summary (too big) or #### (too small)

    2. EMPHASIS:
       - Bold: **text** for important items
       - Italic: *text* for subtle emphasis
       - DO NOT use <b> or <i> HTML tags

    3. LISTS:
       - Numbered: 1. Item one\n2. Item two
       - Bullets: - Item or * Item
       - Nested: Indent with 2 spaces

    4. CODE:
       - Inline code: `variable` or `function()`
       - Code blocks: Only for actual code snippets (3+ lines)
       - DO NOT wrap your entire summary in code blocks!

    5. HORIZONTAL RULES: Use --- on its own line

    6. LINKS: [Text](https://url)

    7. EMOJIS: Use Unicode emojis (‚úÖ üö® ‚ö†Ô∏è üí° üìä)

    === EXACT OUTPUT STRUCTURE ===

    Write your output EXACTLY like this (NO code block wrapper):

    ## üéØ CrewAI Review Summary

    **Status**: ‚úÖ Approved / ‚ö†Ô∏è Needs Attention / üö® Critical Issues

    **Workflows Executed**: {count} workflow(s) completed (Router ‚Üí CI Analysis
    ‚Üí Quick Review [‚Üí Full Review])

    ### üìä Key Metrics
    - **Files Changed**: See CI Analysis for details
    - **CI Status**: ‚úÖ Passed / ‚ö†Ô∏è Warnings / ‚ùå Failed

    ---

    ## ü§ñ Router Suggestions

    {Include suggestions from router_decision.json if any}
    {If none: "No additional workflows recommended ‚úÖ"}

    ---

    ## üö® Critical Issues (Must Fix Before Merge)

    {List critical issues from ALL sources: CI, quick review, full review}
    {If none: "None found ‚úÖ"}

    ---

    ## ‚ö†Ô∏è Warnings (Should Fix Soon)

    {List medium-priority warnings from ALL sources}
    {If none: "None found ‚úÖ"}

    ---

    ## üí° Suggestions (Nice to Have)

    {List improvement suggestions from ALL sources}
    {If none: "Code follows best practices ‚úÖ"}

    ---

    ## ‚úÖ Positive Observations

    {List good patterns, clean code, smart decisions from all reviews}

    ---

    ## üìù Review Details

    ### CI Analysis
    {Summary from ci_summary.json}

    ### Code Review
    {Summary from quick_review.json}

    {If full review ran:}
    ### Technical Deep Dive
    {Summary from full_review.json}

    ---

    ### üîó Quick Links
    - [View Commit](https://github.com/{repository}/commit/{commit_sha})
    - [View Pull Request](https://github.com/{repository}/pull/{pr_number})
    - [CI Logs](https://github.com/{repository}/actions)

    ---

    *ü§ñ Generated by CrewAI Router System | ‚è±Ô∏è {timestamp}*

    === IMPORTANT REMINDERS ===

    1. DO NOT wrap output in ```markdown code blocks
    2. DO NOT try to fetch more data - synthesize what's in workspace
    3. DO use proper markdown headings (##, ###), lists, bold
    4. DO include emojis for visual clarity
    5. DO make it scannable with clear sections
    6. DO write in complete, professional sentences
    7. DO prioritize critical issues at the top
    8. DO include positive observations to balance feedback
    9. IF REQUIRED FILES ARE MISSING: Report as CRITICAL ERROR with explanation

    Your output will be posted to GitHub Actions summary and PR comments. It
    MUST render as beautiful, formatted markdown!

  expected_output: >
    Complete GitHub-flavored markdown report saved to workspace/final_summary.md:
    - Clear heading hierarchy (##, ###)
    - Proper emphasis (bold, italic)
    - Clean lists (numbered and bulleted)
    - Inline code for file/function names
    - Code blocks ONLY for actual code snippets
    - Horizontal rules for section breaks
    - Working links to commit and PR
    - Emojis for visual clarity
    - NO wrapper code blocks around entire output
    - IF files missing: Clear error report explaining what went wrong

    The output will render beautifully on GitHub.
  agent: executive_summary_agent
