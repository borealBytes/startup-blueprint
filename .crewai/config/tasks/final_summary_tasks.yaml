synthesize_summary:
  description: >
    Synthesize all review outputs into a final GitHub-flavored markdown summary
    with DETAILED FINDINGS extracted from workspace JSON files.

    **YOUR TASK**: Read workspace files and create a comprehensive summary that
    shows WHAT was found, not just status.

    WORKSPACE FILES TO READ (use WorkspaceTool):
    1. `router_decision.json` - Router suggestions
    2. `ci_summary.json` - CI analysis (REQUIRED) - Extract critical_errors array
    3. `quick_review.json` - Quick code review - Extract issues array
    4. `full_review.json` - Full technical review - Extract architecture, security, testing arrays
    5. `security_review.json` - Security scan - Extract critical_vulnerabilities array
    6. `diff.txt` - Commit diff (if available)

    **CRITICAL**: Don't just say "Status: failure" - extract the ACTUAL FINDINGS!

    EXAMPLE WORKFLOW:
    ```
    Step 1: Read ci_summary.json using WorkspaceTool
    Step 2: Extract critical_errors array - get message, severity, fix_suggestion
    Step 3: Read full_review.json
    Step 4: Extract architecture array - get title, description, suggestion
    Step 5: Extract security array - get title, description, remediation
    Step 6: Format top 3-5 findings from each category
    Step 7: Write final_summary.md with DETAILED findings, not just status
    ```

    GITHUB MARKDOWN FORMAT (DO NOT wrap in code blocks!):

    ## ‚ö†Ô∏è Review Summary

    **Quick Take**: [One sentence summary with key numbers - e.g., "3 critical
    errors, 5 security vulnerabilities, 4 architecture issues"]

    **PR**: #{{pr_number}}
    **Commit**: `{{commit_sha}}`
    **Repository**: {{repository}}
    **Workflows Executed**: {{count}} workflows

    ---

    ### ‚úÖ CI Analysis
    **Status**: failure

    <details>
    <summary>üî¥ Critical Errors</summary>

    **Type Error in router_label_handler**:
      - Missing import statement for Label type
      - üí° **Fix**: Add `from types import Label` at top of file

    **Build Failure in crewai_integration**:
      - Module 'crewai.agents' has no attribute 'WorkflowAgent'
      - üí° **Fix**: Update to use 'Agent' class from crewai v0.2

    </details>

    ### üîç Full Review

    <details>
    <summary>üèóÔ∏è Critical Architecture Issues</summary>

    **High cyclomatic complexity in router-based review system**
      - Large commit (3221 additions, 30 files) with label-driven workflows
        suggests tightly coupled routing logic.
      - üí° **Suggestion**: Implement clean architecture with clear boundaries:
        1) Router layer, 2) Review orchestration layer, 3) Agent execution layer

    </details>

    <details>
    <summary>üîí Security Vulnerabilities</summary>

    üî¥ **Label injection vulnerability in router workflow selection**
      - Label-driven workflows without proper sanitization allow malicious
        label injection leading to arbitrary code execution.
      - üí° **Fix**: Implement strict label validation with whitelist

    </details>

    ---

    *ü§ñ Generated by CrewAI Router System | ‚è±Ô∏è {{timestamp}}*

    CRITICAL RULES:
    1. DO NOT wrap output in ```markdown blocks
    2. Extract ACTUAL FINDINGS - titles, descriptions, fix suggestions
    3. Use ## for main headings, ### for subheadings
    4. Use <details>/<summary> for collapsible sections
    5. Top 3-5 findings per category
    6. If a file is missing, say "Did not run" - don't error
    7. Focus on ACTIONABLE information, not generic status

  expected_output: >
    GitHub-flavored markdown summary written to final_summary.md via
    WorkspaceTool. Should include:
    - Quick take with counts
    - Detailed findings from ci_summary.json (critical_errors array)
    - Detailed findings from full_review.json (architecture, security, testing)
    - Top 3-5 most critical issues with fix suggestions
    - Collapsible sections for readability
    - Actionable recommendations, not just "Status: failure"

  output_file: final_summary.md
