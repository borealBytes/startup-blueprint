analyze_pr_and_route:
  description: >
    Analyze the pull request and determine which review workflows to execute.

    **IMPORTANT**: The GitHub Actions workflow has ALREADY prepared all data files
    for you in the workspace:
    - `diff.txt`: Full PR diff (base..head) - ALL code changes in this PR
    - `commits.json`: All commits in this PR with stats
    - `diff.json`: PR metadata (number, labels, files changed, additions/deletions)

    You do NOT need to fetch data from GitHub - just READ the files.

    YOUR TASKS:

    1. **Read PR metadata** using WorkspaceTool:
       ```
       WorkspaceTool({"operation": "read", "filename": "diff.json"})
       ```
       This gives you: pr_number, commit_sha, labels, files_changed, additions, deletions

    2. **Read the full PR diff** using WorkspaceTool:
       ```
       WorkspaceTool({"operation": "read", "filename": "diff.txt"})
       ```
       This is the COMPLETE diff for the entire PR - analyze file types, patterns, etc.

    3. **Read commit history** using WorkspaceTool:
       ```
       WorkspaceTool({"operation": "read", "filename": "commits.json"})
       ```
       This gives you all commits in the PR with messages, authors, and stats

    4. **Analyze changeset complexity**:
       - How many files changed?
       - How many lines added/removed?
       - What types of files? (code, tests, config, docs, legal)
       - Are there security-sensitive changes? (.env, secrets, auth)

    5. **Decide which workflows should run** based on labels and analysis

    6. **Suggest additional labels** if you detect patterns the PR author missed

    7. **Write your decision** using WorkspaceTool:
       ```
       WorkspaceTool({
         "operation": "write",
         "filename": "router_decision.json",
         "content": json.dumps({
           "workflows": ["ci-log-analysis", "quick-review"],  # Always include these
           "suggestions": ["Consider adding crewai:full-review label - 44 files changed"],
           "metadata": {
             "pr_number": 4,
             "commit_sha": "abc123",
             "files_changed": 44,
             "lines_added": 4458,
             "lines_removed": 709,
             "complexity": "HIGH"
           },
           "analysis": {
             "complexity": "HIGH",
             "reason": "44 files changed exceeds threshold",
             "file_types_detected": ["python", "yaml", "markdown"],
             "security_files_detected": false
           }
         })
       })
       ```

    **WORKFLOW DECISION RULES**:
    - **ALWAYS include**: `["ci-log-analysis", "quick-review"]` (these are the default baseline)
    - **IF** "crewai:full-review" label present → add `"full-review"` to workflows array
    - **IF** "crewai:legal" label present → add `"legal-review"` to workflows array

    **SUGGESTION RULES** (suggest labels even if not present):
    - **IF** files_changed > 20 **OR** lines_changed > 500 → suggest `"crewai:full-review"`
    - **IF** legal files detected (LICENSE, TERMS, PRIVACY, CONTRIBUTING) → suggest `"crewai:legal"`
    - **IF** security-sensitive files (.env*, *secret*, *key*, auth*, credential*) → **warn immediately** in suggestions
    - **IF** test files modified without code changes → suggest reviewing test coverage
    - **IF** only documentation changed → note that quick review may be sufficient

    **FILE TYPE DETECTION** (scan diff.txt for these patterns):
    - **Legal**: LICENSE*, TERMS*, PRIVACY*, CONTRIBUTING*, COPYRIGHT*
    - **Security**: .env*, *secret*, *key*, auth*, credential*, *password*
    - **Config**: *.yml, *.yaml, *.json, *.toml, Dockerfile*, docker-compose*
    - **Documentation**: *.md, docs/*, README*
    - **Tests**: *test*, *spec*, __tests__/*, tests/*
    - **Infrastructure**: .github/*, terraform/*, k8s/*, kubernetes/*

    **COMPLEXITY ASSESSMENT**:
    - **LOW**: < 5 files, < 100 lines changed
    - **MEDIUM**: 5-20 files OR 100-500 lines changed
    - **HIGH**: > 20 files OR > 500 lines changed

    **CRITICAL REQUIREMENTS**:
    - You MUST call WorkspaceTool with operation="write" to save router_decision.json
    - DO NOT attempt to fetch data from GitHub APIs - all data is pre-prepared
    - DO NOT just return JSON as text - it must be written to the file
    - The diff.txt file contains the FULL PR diff, not just the latest commit

  expected_output: >
    Complete routing decision WRITTEN to router_decision.json file using
    WorkspaceTool with:
    - List of workflows to execute (always include ci-log-analysis and quick-review)
    - Intelligent suggestions for additional labels based on code analysis
    - PR metadata and complexity assessment
    - Analysis reasoning explaining why certain workflows were selected

    The router_decision.json file must exist in workspace after task completion.
    Other agents will read this file to understand what workflows ran.
