# Task 1: Triage - Identify what broke
triage_failures:
  description: >
    Analyze the CI job index and individual job summaries to identify which jobs failed.
    
    1. Call read_job_index() to get the full list of jobs.
    2. For every job, call read_job_summary(folder_name).
    3. Identify jobs with status "failure" or "cancelled".
    
    This task creates the "investigation plan" for the next agent.
  expected_output: >
    A JSON-structured list of failed jobs, their folder names, and a brief summary of the failure 
    from the summary files. If no jobs failed, report that all passed.
  agent: ci_pipeline_lead

# Task 2: Investigation - Get the evidence
investigate_logs:
  description: >
    For each failed job identified in the triage phase, extract the specific error evidence.
    
    For each failed job:
    1. Call check_log_size(folder_name) FIRST.
    2. If log < 50KB: Use read_full_log(folder_name).
    3. If log > 50KB: Use search_log(folder_name, pattern) with smart patterns 
       (e.g., "error", "exception", "failed", "fatal").
    4. Use get_log_stats(folder_name) to gauge error density.
    
    Do NOT analyze the root cause yetâ€”just extract the raw exception traces and error messages.
  expected_output: >
    Detailed log snippets containing the specific error traces, stack dumps, or failure messages 
    for each failed job.
  agent: log_pattern_specialist

# Task 3: Resolution - Explain and Fix
determine_root_cause:
  description: >
    Analyze the extracted log evidence to determine the technical root cause and provide fixes.
    
    For each error trace found:
    1. Explain WHY it failed (e.g., "Missing dependency", "Syntax error", "Timeout").
    2. Provide a specific, actionable fix (e.g., "Add package X to package.json", "Fix typo in line 42").
    3. Classify severity (Critical/Warning).
  expected_output: >
    A structured analysis of each failure, including Root Cause, Fix Recommendation, and Severity.
  agent: error_resolution_specialist

# Task 4: Reporting - Final Summary
compile_ci_report:
  description: >
    Synthesize all findings into the final ci_summary.json file.
    
    1. Combine the triage status, log evidence, and root cause analysis.
    2. Use CIOutputParserTool to get core CI status.
    3. Use WorkspaceTool to read diff.json for context if needed.
    4. Write the final JSON file using WorkspaceTool(operation="write", filename="ci_summary.json", ...).
    
    Required JSON structure:
    {
      "status": "success|warning|failure",
      "summary": "High-level summary",
      "jobs_analyzed": [...],
      "critical_errors": [{type, file, line, message, fix_suggestion, job}],
      "warnings": [...],
      "merge_status": "APPROVE|REQUEST_CHANGES",
      "merge_rationale": "..."
    }
  expected_output: >
    "Successfully wrote ci_summary.json with N critical errors and M warnings."
  agent: ci_pipeline_lead
