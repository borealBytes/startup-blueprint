# Task 1: Triage - Identify what broke using enhanced parser
triage_failures:
  description: >
    Analyze CI logs using the enhanced CIOutputParserTool to extract ALL errors.

    CRITICAL STEPS:
    1. Call CIOutputParserTool._run(ci_logs_dir="ci_results") to get FULL parsed output
       with detailed errors from stylelint, sqlfluff, markdownlint, etc.
    2. Also call read_job_index() to get job metadata
    3. Identify all jobs with errors from the parser output (check critical_errors and warnings)
    4. Create investigation plan with:
       - Jobs with detailed error counts from parser
       - Specific tools that reported errors (stylelint, sqlfluff, etc.)
       - File paths and line numbers from parser output

    The parser output contains structured data with: status, passed, summary,
    checks_performed, critical_errors[], warnings[], jobs_analyzed[].
    Use this data directly for your analysis.
  expected_output: >
    Detailed investigation plan including: jobs with errors, specific CI tools
    that failed, error counts from parser, and file paths needing review.
  agent: ci_pipeline_lead

# Task 2: Investigation - Get the evidence
investigate_logs:
  description: >
    For each failed job identified in the triage phase, extract the specific
    error evidence.

    For each failed job: 1. Call check_log_size(folder_name) FIRST. 2. If log <
    50KB: Use read_full_log(folder_name). 3. If log > 50KB: Use
    search_log(folder_name, pattern) with smart patterns
       (e.g., "error", "exception", "failed", "fatal").
    4. Use get_log_stats(folder_name) to gauge error density.

    Do NOT analyze the root cause yetâ€”just extract the raw exception traces and
    error messages.
  expected_output: >
    Detailed log snippets containing the specific error traces, stack dumps, or
    failure messages for each failed job.
  agent: log_pattern_specialist

# Task 3: Resolution - Explain and Fix
determine_root_cause:
  description: >
    Analyze the extracted log evidence to determine the technical root cause and
    provide fixes.

    For each error trace found: 1. Explain WHY it failed (e.g., "Missing
    dependency", "Syntax error", "Timeout"). 2. Provide a specific, actionable
    fix (e.g., "Add package X to package.json", "Fix typo in line 42"). 3.
    Classify severity (Critical/Warning).
  expected_output: >
    A structured analysis of each failure, including Root Cause, Fix
    Recommendation, and Severity.
  agent: error_resolution_specialist

# Task 4: Reporting - Final Summary
compile_ci_report:
  description: >
    Synthesize all findings into the final ci_summary.json file.

    STEPS:
    1. Call CIOutputParserTool with ci_logs_dir="ci_results" to get DETAILED
       parsed output including all stylelint, sqlfluff, and other CI errors.
    2. Combine the triage status, log evidence, and root cause analysis.
    3. Use WorkspaceTool to read diff.json for context if needed.
    4. Write the final JSON file using WorkspaceTool.

    CRITICAL: You MUST call CIOutputParserTool._run with ci_logs_dir parameter
    to get the full error details. Do NOT rely only on search_log results.

    Required JSON structure: {
      "status": "success|warning|failure",
      "summary": "High-level summary with specific error counts",
      "checks_performed": ["stylelint", "sqlfluff", ...],
      "jobs_analyzed": [...],
      "critical_errors": [{type, file, line, message, fix_suggestion, tool}],
      "warnings": [...],
      "merge_status": "APPROVE|REQUEST_CHANGES",
      "merge_rationale": "..."
    }
  expected_output: >
    "Successfully wrote ci_summary.json with N critical errors and M warnings from specific tools."
  agent: ci_pipeline_lead
